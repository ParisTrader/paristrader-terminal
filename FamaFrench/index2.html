<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParisTrader Pro | Quant Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- å…¨å±€è¨­ç½® --- */
        :root {
            --sidebar-width: 260px;
            --sidebar-bg: #1e293b; /* æ·±è—ç°è‰² */
            --sidebar-text: #94a3b8;
            --sidebar-active: #3b82f6; /* äº®è—è‰² */
            --main-bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-primary: #334155;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--main-bg); margin: 0; padding: 0; color: var(--text-primary); display: flex; height: 100vh; overflow: hidden; }

        /* --- 1. ç™»å…¥é®ç½© (ä¿ç•™æ‚¨çš„å¯†ç¢¼é–) --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; }
        .login-input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; text-align: center; letter-spacing: 2px; }
        .login-btn { width: 100%; padding: 12px; background: var(--sidebar-active); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .login-btn:hover { background: #2563eb; }

        /* --- 2. å´é‚Šæ¬„ (Sidebar) --- */
        .sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); display: flex; flex-direction: column; height: 100%; transition: 0.3s; flex-shrink: 0; }
        .logo-area { padding: 25px; font-size: 1.2rem; font-weight: bold; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        
        .nav-menu { list-style: none; padding: 20px 10px; margin: 0; flex: 1; }
        .nav-item { margin-bottom: 5px; }
        .nav-link { display: flex; align-items: center; padding: 12px 15px; color: var(--sidebar-text); text-decoration: none; border-radius: 8px; transition: 0.2s; cursor: pointer; font-size: 0.95rem; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--sidebar-active); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        .nav-link i { width: 25px; margin-right: 10px; text-align: center; }

        .user-profile { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); color: white; display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .user-avatar { width: 35px; height: 35px; background: #64748b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* --- 3. ä¸»è¦å…§å®¹å€ (Main Content) --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* é ‚éƒ¨å°èˆªæ¬„ (Header) */
        .top-bar { height: 64px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .page-title { font-size: 1.2rem; font-weight: 600; color: #1e293b; }
        .data-status { font-size: 0.85em; color: #64748b; background: #f1f5f9; padding: 5px 12px; border-radius: 20px; }

        /* å…§å®¹æ²å‹•å€ */
        .scrollable-content { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* å…§å®¹å¡ç‰‡æ¨£å¼ */
        .dashboard-card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        
        /* --- 4. å…·é«”å·¥å…·æ¨£å¼ (ç§»æ¤è‡ªåŸç‰ˆ) --- */
        .control-panel { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 25px; }
        input[type="text"], input[type="number"] { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; text-transform: uppercase; font-weight: bold; text-align: center; width: 200px; }
        input:focus { border-color: var(--sidebar-active); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        /* ç¯©é¸æŒ‰éˆ• */
        .filter-section { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 15px; }
        .filter-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #cbd5e1; background: white; color: #64748b; cursor: pointer; transition: 0.2s; font-size: 0.85em; font-weight: 500; }
        .filter-btn:hover { border-color: var(--sidebar-active); color: var(--sidebar-active); }

        /* ç¯©é¸çµæœ */
        #filter-results-container { display: none; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1; text-align: center; }
        .stock-btn { background: white; border: 1px solid var(--sidebar-active); color: var(--sidebar-active); padding: 4px 10px; border-radius: 4px; cursor: pointer; margin: 3px; font-weight: bold; font-size: 0.9em; }
        .stock-btn:hover { background: var(--sidebar-active); color: white; }

        /* åœ–è¡¨ä½ˆå±€ */
        .grid-layout { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 25px; align-items: start; }
        .canvas-container { height: 450px; position: relative; }
        
        /* åˆ†æé¢æ¿ */
        .insight-panel { background: #f8fafc; border-radius: 10px; padding: 20px; border-left: 4px solid var(--sidebar-active); }
        .insight-title { font-weight: bold; font-size: 1.1em; margin-bottom: 15px; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .insight-list { padding-left: 20px; margin: 0; }
        .insight-list li { margin-bottom: 10px; font-size: 0.95em; line-height: 1.5; color: #475569; }
        .highlight { font-weight: 700; color: #0f172a; }

        /* è¶¨å‹¢åœ– */
        .trend-container { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        .trend-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trend-tag { font-size: 0.8em; background: #e2e8f0; padding: 4px 8px; border-radius: 4px; color: #475569; }

        /* æŠ•è³‡çµ„åˆè¡¨æ ¼ */
        .pf-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .pf-table th { text-align: left; padding: 10px; color: #64748b; font-size: 0.9em; border-bottom: 1px solid #e2e8f0; }
        .pf-table td { padding: 8px 5px; }
        .action-btn { background: #10b981; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .action-btn:hover { background: #059669; }
        .remove-btn { color: #ef4444; cursor: pointer; font-size: 1.2em; }

        /* Tab å…§å®¹åˆ‡æ›æ©Ÿåˆ¶ (æ ¸å¿ƒ) */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .sidebar { width: 100%; height: auto; }
            .nav-menu { display: flex; overflow-x: auto; padding: 10px; gap: 5px; }
            .nav-link { white-space: nowrap; padding: 8px 12px; font-size: 0.9em; }
            .user-profile { display: none; }
            .grid-layout { grid-template-columns: 1fr; }
            .main-content { height: auto; overflow: visible; }
            .scrollable-content { padding: 15px; }
        }
        
        /* æ¨™ç±¤é›² */
        #tags-container { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .tag.blue { background: #e0f2fe; color: #0284c7; }
        .tag.red { background: #fee2e2; color: #dc2626; }
        .tag.green { background: #dcfce7; color: #16a34a; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:#1e293b;">ğŸ”’ ParisTrader Pro</h2>
            <p style="color:#64748b; font-size:0.9em;">Private Quantitative Research Platform</p>
            <input type="password" id="passwordInput" class="login-input" placeholder="ACCESS CODE">
            <button onclick="checkPassword()" class="login-btn">ENTER SYSTEM</button>
            <p id="error-msg" style="color:#ef4444; display:none; margin-top:10px; font-size:0.9em;">Access Denied</p>
        </div>
    </div>

    <nav class="sidebar">
        <div class="logo-area">
            <i class="fa-solid fa-chart-radar"></i> ParisTrader
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" onclick="switchView('single', this)">
                    <i class="fa-solid fa-magnifying-glass-chart"></i> å€‹è‚¡é«”æª¢
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('peer', this)">
                    <i class="fa-solid fa-scale-balanced"></i> åŒæ¥­æ¯”å°
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('portfolio', this)">
                    <i class="fa-solid fa-briefcase"></i> æŠ•è³‡çµ„åˆ
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="switchView('about', this)">
                    <i class="fa-solid fa-circle-info"></i> é—œæ–¼ç³»çµ±
                </a>
            </li>
        </ul>
        <div class="user-profile">
            <div class="user-avatar">PT</div>
            <div>
                <div style="font-weight:bold;">Client User</div>
                <div style="font-size:0.8em; color:#94a3b8;">VIP Access</div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <header class="top-bar">
            <div class="page-title" id="page-title">Stock Factor DNA</div>
            <div class="data-status" id="data-date">Data Date: Loading...</div>
        </header>

        <div class="scrollable-content">

            <div id="view-single" class="view-section active">
                <div class="dashboard-card">
                    <div class="control-panel">
                        <input type="text" id="tickerInput" placeholder="è¼¸å…¥ä»£ç¢¼ (e.g. AAPL)" onkeyup="if(event.key==='Enter') updateSingleChart()">
                    </div>
                    
                    <div class="filter-section">
                        <button onclick="filterStocks('High Quality')" class="filter-btn">ğŸ’ High Quality</button>
                        <button onclick="filterStocks('High Growth')" class="filter-btn">ğŸš€ High Growth</button>
                        <button onclick="filterStocks('Deep Value')" class="filter-btn">ğŸ’° Deep Value</button>
                        <button onclick="filterStocks('Small Cap')" class="filter-btn">ğŸ£ Small Cap</button>
                        <button onclick="filterStocks('Defensive')" class="filter-btn">ğŸ›¡ï¸ Defensive</button>
                    </div>

                    <div id="filter-results-container">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span style="font-size:0.9em; color:#64748b;">ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ï¼š</span>
                            <span style="cursor:pointer; color:#ef4444;" onclick="document.getElementById('filter-results-container').style.display='none'"><i class="fa-solid fa-xmark"></i></span>
                        </div>
                        <div id="filter-results-buttons"></div>
                    </div>
                </div>

                <div class="grid-layout">
                    <div class="dashboard-card" style="margin-bottom:0;">
                        <div class="canvas-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div id="tags-container"></div>
                        
                        <div id="trend-wrapper" class="trend-container" style="display:none;">
                            <div class="trend-header">
                                <span style="font-weight:bold; color:#334155;"><i class="fa-solid fa-arrow-trend-up"></i> æ­·å²é¢¨éšªèµ°å‹¢ (Beta Trend)</span>
                                <span class="trend-tag">Last 2 Years</span>
                            </div>
                            <div style="font-size:0.85em; color:#64748b; margin-bottom:10px;">
                                ç´…ç·šç‚ºå¯¦éš› Betaï¼Œè™›ç·š (1.0) ç‚ºå¤§ç›¤åŸºæº–ã€‚æŒçºŒé«˜æ–¼è™›ç·šä»£è¡¨é«˜é¢¨éšªã€‚
                            </div>
                            <div style="height: 120px; width:100%;">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="insight-panel" id="insight-panel" style="display:none;">
                        <div class="insight-title">
                            <i class="fa-solid fa-robot"></i> AI åˆ†æå ±å‘Š: <span id="insight-title-text">--</span>
                        </div>
                        <ul class="insight-list" id="insight-content"></ul>
                    </div>
                </div>
            </div>

            <div id="view-peer" class="view-section">
                <div class="dashboard-card">
                    <div class="control-panel">
                        <input type="text" id="peerA" placeholder="è‚¡ç¥¨ A (e.g. KO)">
                        <span style="font-weight:bold; color:#94a3b8; align-self:center;">VS</span>
                        <input type="text" id="peerB" placeholder="è‚¡ç¥¨ B (e.g. PEP)">
                        <button class="action-btn" onclick="updatePeerChart()">é–‹å§‹æ¯”è¼ƒ</button>
                    </div>
                </div>
                </div>

            <div id="view-portfolio" class="view-section">
                <div class="dashboard-card">
                    <table class="pf-table" id="portfolioTable">
                        <thead><tr><th>è‚¡ç¥¨ä»£ç¢¼</th><th>æ¬Šé‡ %</th><th>æ“ä½œ</th></tr></thead>
                        <tbody>
                            <tr><td><input type="text" class="portfolio-input" value="AAPL" style="width:100px;"></td><td><input type="number" class="weight-input" value="50" style="width:80px;"></td><td><i class="fa-solid fa-trash remove-btn" onclick="removeRow(this)"></i></td></tr>
                            <tr><td><input type="text" class="portfolio-input" value="KO" style="width:100px;"></td><td><input type="number" class="weight-input" value="50" style="width:80px;"></td><td><i class="fa-solid fa-trash remove-btn" onclick="removeRow(this)"></i></td></tr>
                        </tbody>
                    </table>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <button onclick="addPortfolioRow()" style="background:#3b82f6; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;"><i class="fa-solid fa-plus"></i> æ–°å¢è‚¡ç¥¨</button>
                        <button class="action-btn" onclick="updatePortfolioChart()"><i class="fa-solid fa-calculator"></i> è¨ˆç®—çµ„åˆ DNA</button>
                    </div>
                </div>
            </div>

            <div id="view-about" class="view-section">
                <div class="dashboard-card">
                    <h3 style="border-bottom:2px solid #3b82f6; padding-bottom:10px; display:inline-block;">é—œæ–¼ç³»çµ±</h3>
                    <p style="line-height:1.8; color:#475569;">
                        <strong>Stock Factor DNA</strong> æ˜¯ä¸€å¥—åŸºæ–¼ Fama-French å¤šå› å­æ¨¡å‹çš„é‡åŒ–åˆ†æç³»çµ±ã€‚æ•¸æ“šæºè‡ª Kenneth French Data Libraryã€‚
                        æœ¬ç³»çµ±æ—¨åœ¨å”åŠ©æŠ•è³‡è€…ä»¥æ©Ÿæ§‹è¦–è§’é€è¦–è‚¡ç¥¨çš„çµæ§‹æ€§é¢¨éšªç‰¹å¾µã€‚
                    </p>
                    <div style="background:#f1f5f9; padding:20px; border-radius:8px; margin-top:20px;">
                        <strong>Developed by ParisTrader</strong><br>
                        <div style="margin-top:10px;">
                            <a href="https://t.me/algoparistrader" target="_blank" style="text-decoration:none; color:#3b82f6; font-weight:bold; margin-right:15px;"><i class="fa-brands fa-telegram"></i> Telegram Channel</a>
                            <a href="https://t.me/ParisTrader" target="_blank" style="text-decoration:none; color:#3b82f6; font-weight:bold;"><i class="fa-solid fa-envelope"></i> Contact Me</a>
                        </div>
                    </div>
                    
                    <div style="margin-top:30px; font-size:0.85em; color:#94a3b8; border-top:1px solid #e2e8f0; padding-top:20px;">
                        <strong>å…è²¬è²æ˜ï¼š</strong> æœ¬å·¥å…·åƒ…ä¾›å­¸è¡“äº¤æµèˆ‡è¼”åŠ©åˆ†æï¼ŒéæŠ•è³‡å»ºè­°ã€‚éå¾€è¡¨ç¾ä¸ä»£è¡¨æœªä¾†ã€‚å› å­æ•¸æ“šå…·æœ‰ç´„ 1-1.5 å€‹æœˆçš„æ»¯å¾Œæ€§ï¼Œåƒ…åæ˜ ä¸­é•·æœŸçµæ§‹ç‰¹å¾µã€‚
                    </div>
                </div>
            </div>

        </div>
    </main>

<script>
    // --- å¯†ç¢¼é–é‚è¼¯ ---
    function checkPassword() {
        if(document.getElementById('passwordInput').value === "VIP888") {
            document.getElementById('login-overlay').style.display = 'none';
        } else {
            document.getElementById('error-msg').style.display = 'block';
        }
    }

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let stockData = {};
    let myChart = null;
    let trendChart = null;
    let lastState = { tab: 'single', singleTicker: '', peerA: '', peerB: '', hasPortfolioRun: false };

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        Papa.parse("stock_factor_data.csv", {
            download: true, header: true,
            complete: function(results) {
                results.data.forEach(row => { if(row.Ticker) stockData[row.Ticker] = row; });
                if(Object.keys(stockData).length > 0) {
                    let first = Object.keys(stockData)[0];
                    document.getElementById('tickerInput').value = first;
                    document.getElementById('data-date').innerText = "Data Updated: " + stockData[first].Last_Date;
                    updateSingleChart();
                }
            }
        });
    };

    // --- é é¢åˆ‡æ›é‚è¼¯ (App è·¯ç”±) ---
    function switchView(viewId, navElement) {
        // 1. æ›´æ–° Sidebar ç‹€æ…‹
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        if(navElement) navElement.classList.add('active');

        // 2. æ›´æ–°ä¸»è¦å…§å®¹å€
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');

        // 3. æ›´æ–°æ¨™é¡Œ
        const titles = { 'single': 'å€‹è‚¡é«”æª¢', 'peer': 'åŒæ¥­æ¯”å°', 'portfolio': 'æŠ•è³‡çµ„åˆè¨ºæ–·', 'about': 'é—œæ–¼èˆ‡åƒè€ƒ' };
        document.getElementById('page-title').innerText = titles[viewId];

        // 4. ç§»å‹• Canvas (é‡è¦ï¼ç‚ºäº†å¾©ç”¨ Canvasï¼Œæˆ‘å€‘å°‡å®ƒç§»å‹•åˆ°ç•¶å‰ View)
        // æ³¨æ„ï¼šChart.js éœ€è¦ Canvas åœ¨ DOM ä¸­å¯è¦‹æ‰èƒ½æ¸²æŸ“ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ peer æˆ– portfolioï¼Œæˆ‘å€‘è¦ç¢ºä¿é‚è¼¯æ­£ç¢º
        // é€™è£¡ç°¡åŒ–è™•ç†ï¼šå¦‚æœä¸æ˜¯ About é é¢ï¼Œä¸”éœ€è¦åœ–è¡¨ï¼Œæˆ‘å€‘å°‡åœ–è¡¨å®¹å™¨ç§»å‹•åˆ°ç•¶å‰ View çš„ grid-layout ä¸­
        // ä½†ç‚ºäº†ä»£ç¢¼ç°¡å–®ï¼Œæˆ‘å€‘ä½¿ç”¨ "å…±ç”¨åœ–è¡¨å€" çš„æ¦‚å¿µï¼Œæˆ–è€…ç°¡å–®åœ°åœ¨ switch æ™‚é‡ç¹ª
        
        // æ›´ç°¡å–®çš„åšæ³•ï¼šæ‰€æœ‰åœ–è¡¨é‚è¼¯å…±ç”¨åŒä¸€å€‹ Canvas IDï¼Œä½†åœ¨åˆ‡æ›æ™‚æˆ‘å€‘æŠŠåœ–è¡¨å®¹å™¨ "æ¬å®¶" (AppendChild)
        // æˆ–è€…ï¼Œç‚ºäº†é¿å…è¤‡é›œåº¦ï¼Œæˆ‘å€‘åœ¨ View Peer å’Œ Portfolio ä¸­ä¸å¯«æ­» HTMLï¼Œè€Œæ˜¯ç”¨ JS å‹•æ…‹ç”Ÿæˆã€‚
        // **ä¿®æ­£ç­–ç•¥**ï¼šå› ç‚º CSS Grid ä½ˆå±€ï¼Œç›´æ¥è®“ Canvas ç•™åœ¨åŸä½ï¼Œåªåœ¨ Peer/Portfolio é¡¯ç¤ºæ™‚ï¼Œ
        // æˆ‘å€‘æ‰‹å‹•éš±è— single çš„ control panelï¼Œé¡¯ç¤º peer çš„ control panelã€‚
        // ä½†ç‚ºäº†æ¨¡ä»¿ App æ„Ÿè¦ºï¼Œæˆ‘é€™è£¡åšä¸€å€‹ç°¡å–®çš„è™•ç†ï¼š

        // æ¸…ç†èˆŠåœ–è¡¨
        if(myChart) myChart.destroy();
        if(trendChart) trendChart.destroy();
        document.getElementById('insight-panel').style.display = 'none';
        document.getElementById('tags-container').innerHTML = '';
        document.getElementById('trend-wrapper').style.display = 'none';

        // ç‹€æ…‹æ¢å¾©
        if (viewId === 'single') {
            // å°‡åœ–è¡¨å®¹å™¨æ¬å› single view
            let container = document.querySelector('.grid-layout'); 
            let chartCard = document.querySelectorAll('.dashboard-card')[1]; // é€™æ˜¯æ”¾åœ–è¡¨çš„å¡ç‰‡
            if(!document.getElementById('view-single').contains(chartCard)) {
               document.querySelector('#view-single .grid-layout').prepend(chartCard);
            }
            if(lastState.singleTicker) updateSingleChart(true);

        } else if (viewId === 'peer') {
            // å°‡åœ–è¡¨å¡ç‰‡æ¬åˆ° peer view
            let chartCard = document.querySelectorAll('.dashboard-card')[1]; // æ°¸é æŠ“é‚£å€‹æœ‰ canvas çš„ card
            document.getElementById('view-peer').appendChild(chartCard);
            if(lastState.peerA && lastState.peerB) updatePeerChart(true);

        } else if (viewId === 'portfolio') {
            let chartCard = document.querySelectorAll('.dashboard-card')[1];
            document.getElementById('view-portfolio').appendChild(chartCard);
            if(lastState.hasPortfolioRun) updatePortfolioChart();
        }
    }

    // --- åŠŸèƒ½ 1: å€‹è‚¡ ---
    function updateSingleChart(isRestore = false) {
        let ticker = isRestore ? lastState.singleTicker : document.getElementById('tickerInput').value.toUpperCase().trim();
        if(!isRestore) lastState.singleTicker = ticker;

        let data = stockData[ticker];
        if(!data) { if(!isRestore) alert("æ‰¾ä¸åˆ°è‚¡ç¥¨"); return; }

        showInsightPanel(ticker);
        renderTags(data.Baskets);
        generateInsights(data, 'single');
        renderRadar([{ label: ticker, data: getScores(data), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)' }]);
        
        if (data.Beta_Trend) {
            document.getElementById('trend-wrapper').style.display = 'block';
            renderTrendChart(data.Beta_Trend);
        }
        document.getElementById('filter-results-container').style.display = 'none';
    }

    // --- åŠŸèƒ½ 2: åŒæ¥­ ---
    function updatePeerChart(isRestore = false) {
        let tA = isRestore ? lastState.peerA : document.getElementById('peerA').value.toUpperCase().trim();
        let tB = isRestore ? lastState.peerB : document.getElementById('peerB').value.toUpperCase().trim();
        if(!isRestore) { lastState.peerA = tA; lastState.peerB = tB; }

        let dataA = stockData[tA], dataB = stockData[tB];
        if(!dataA || !dataB) return;

        showInsightPanel(`${tA} vs ${tB}`);
        generateInsightsPeer(dataA, dataB);
        renderRadar([
            { label: tA, data: getScores(dataA), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)' },
            { label: tB, data: getScores(dataB), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.2)' }
        ]);
    }

    // --- åŠŸèƒ½ 3: æŠ•è³‡çµ„åˆ ---
    function addPortfolioRow() {
        let tbody = document.querySelector('#portfolioTable tbody');
        if(tbody.rows.length >= 10) return;
        let row = tbody.insertRow();
        row.innerHTML = `<td><input type="text" class="portfolio-input" style="width:100px;"></td><td><input type="number" class="weight-input" value="0" style="width:80px;"></td><td><i class="fa-solid fa-trash remove-btn" onclick="removeRow(this)"></i></td>`;
    }
    function removeRow(btn) { btn.closest('tr').remove(); }

    function updatePortfolioChart() {
        let rows = document.querySelectorAll('#portfolioTable tbody tr');
        let scores = [0,0,0,0,0], totalWeight = 0;
        
        for(let row of rows) {
            let t = row.querySelector('.portfolio-input').value.toUpperCase().trim();
            let w = parseFloat(row.querySelector('.weight-input').value);
            if(t && stockData[t]) {
                totalWeight += w;
                let s = getScores(stockData[t]);
                for(let i=0; i<5; i++) scores[i] += s[i]*(w/100);
            }
        }
        if(Math.abs(totalWeight-100)>0.5) { alert("ç¸½æ¬Šé‡éœ€ç‚º 100%"); return; }
        
        lastState.hasPortfolioRun = true;
        showInsightPanel("My Portfolio");
        generateInsights({Score_Beta: scores[0], Score_Mom: scores[1], Score_Quality: scores[2], Score_Size: scores[3], Score_Value: scores[4]}, 'portfolio');
        renderRadar([{ label: 'Portfolio', data: scores, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.2)' }]);
    }

    // --- ç¹ªåœ–èˆ‡è¼”åŠ© ---
    function getScores(d) { return [d.Score_Beta, d.Score_Mom, d.Score_Quality, d.Score_Size, d.Score_Value]; }
    
    function showInsightPanel(title) {
        document.getElementById('insight-panel').style.display = 'block';
        document.getElementById('insight-title-text').innerText = title;
    }

    function renderRadar(datasets) {
        if(myChart) myChart.destroy();
        myChart = new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: { labels: ['Beta (æ³¢å‹•)', 'Momentum (å‹•èƒ½)', 'Quality (å“è³ª)', 'Size (è¦æ¨¡)', 'Value (åƒ¹å€¼)'], datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { suggestedMin: 0, suggestedMax: 10, pointLabels: { font: { size: 12, weight: 'bold' } } } }
            }
        });
    }

    // è¶¨å‹¢åœ–é‚è¼¯ (å« 1.0 åŸºæº–ç·š)
    const linePlugin = {
        id: 'hLine', beforeDraw: (c) => {
            const { ctx, scales: { x, y } } = c;
            const yVal = y.getPixelForValue(1.0);
            ctx.save(); ctx.strokeStyle = '#94a3b8'; ctx.setLineDash([5,5]); 
            ctx.beginPath(); ctx.moveTo(x.left, yVal); ctx.lineTo(x.right, yVal); ctx.stroke(); ctx.restore();
        }
    };
    function renderTrendChart(trendStr) {
        if(trendChart) trendChart.destroy();
        let data = trendStr.split(',').map(Number);
        trendChart = new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: { labels: data.map((_,i)=>i), datasets: [{ data: data, borderColor: '#ef4444', borderWidth: 2, pointRadius: 0, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: {display:false}, y: {suggestedMin: 0.5, suggestedMax: 1.5} } },
            plugins: [linePlugin]
        });
    }

    // AI åˆ†æé‚è¼¯ (æ•´åˆç‰ˆ)
    function generateInsights(d, mode) {
        const ul = document.getElementById('insight-content'); ul.innerHTML = '';
        const add = (t, c) => ul.innerHTML += `<li><span class="highlight">${t}</span> ${c}</li>`;
        
        let beta = parseFloat(d.Score_Beta || d[0]); // ç›¸å®¹ array
        let val = parseFloat(d.Score_Value || d[4]);
        
        if(mode === 'portfolio') {
            add(beta > 7 ? "é«˜é¢¨éšªè­¦ç¤º:" : beta < 4 ? "é˜²ç¦¦å‹é…ç½®:" : "å¹³è¡¡å‹:", beta > 7 ? "çµ„åˆæ³¢å‹•åŠ‡çƒˆï¼Œå»ºè­°é™ä½æ§“æ¡¿ã€‚" : "é©åˆä¿å®ˆæŠ•è³‡è€…ã€‚");
        } else {
            if(beta > 8) add("æ¥µé«˜æ³¢å‹•:", "å¿ƒè·³è‚¡ï¼Œå‹™å¿…è¨­æ­¢æã€‚");
            else if(beta < 3) add("é¿é¢¨æ¸¯:", "æŠ—è·Œå±¬æ€§å¼·ã€‚");
            else if(beta >=4 && beta <=6) add("è·Ÿéš¨å¤§ç›¤:", "æ¨™æº–å¸‚å ´é¢¨éšªã€‚");
            
            if(val > 7) add("æ·±åº¦åƒ¹å€¼:", "ä¼°å€¼ä¾¿å®œï¼Œç•™æ„åƒ¹å€¼é™·é˜±ã€‚");
            else if(val >= 2.5 && val <= 5) add("åˆç†æˆé•· (GARP):", "ä¼°å€¼åˆç†ï¼Œå…·æˆé•·æ€§ã€‚");
        }
    }
    
    function generateInsightsPeer(dA, dB) {
        const ul = document.getElementById('insight-content'); ul.innerHTML = '';
        ul.innerHTML = `<li><span class="highlight">æ¯”è¼ƒé‡é»:</span> è§€å¯Ÿå…©è€…å½¢ç‹€é‡ç–Šåº¦ã€‚</li>`;
        ul.innerHTML += `<li><span class="highlight">${dA.Ticker}:</span> Beta ${dA.Score_Beta}, Value ${dA.Score_Value}</li>`;
        ul.innerHTML += `<li><span class="highlight">${dB.Ticker}:</span> Beta ${dB.Score_Beta}, Value ${dB.Score_Value}</li>`;
    }

    function filterStocks(c) {
        let div = document.getElementById('filter-results-buttons'); div.innerHTML = '';
        let count = 0;
        for(let t in stockData) {
            if(stockData[t].Baskets && stockData[t].Baskets.includes(c)) {
                let btn = document.createElement('button'); btn.className = 'stock-btn'; btn.innerText = t;
                btn.onclick = function() { document.getElementById('tickerInput').value = t; updateSingleChart(); };
                div.appendChild(btn); count++;
            }
        }
        document.getElementById('filter-results-container').style.display = count ? 'block' : 'none';
        if(count==0) alert('ç„¡ç¬¦åˆçµæœ');
    }
    
    function renderTags(str) {
        const div = document.getElementById('tags-container'); div.innerHTML = '';
        if(str) str.split(';').forEach(tag => {
            let s = document.createElement('span'); s.className = 'tag blue';
            if(tag.includes('Aggressive')) s.className = 'tag red';
            if(tag.includes('Quality')) s.className = 'tag green';
            s.innerText = tag.trim(); div.appendChild(s);
        });
    }
</script>

</body>
</html>