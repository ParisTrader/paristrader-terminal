<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Stock Factor DNA: Retail Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* --- åŸºç¤è¦–è¦ºå„ªåŒ– --- */
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --danger: #e74c3c;
            --success: #27ae60;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; color: var(--text-main); line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card-bg); padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; color: #1a1a1a; letter-spacing: 1px; font-size: 1.8rem; }
        .subtitle { color: var(--text-sub); margin-top: 8px; font-size: 0.95em; }

        /* --- Tab å°èˆª (æ‰‹æ©Ÿå‹å–„) --- */
        .tabs { display: flex; justify-content: center; margin-bottom: 25px; gap: 8px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 18px; border: none; background: #eef2f5; border-radius: 20px; cursor: pointer; font-weight: 600; color: #666; transition: 0.2s; font-size: 0.9rem; flex: 1 1 auto; max-width: 150px; }
        .tab-btn.active { background: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(0,123,255,0.25); }
        .tab-btn:hover:not(.active) { background: #dbe2e8; }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- æ§åˆ¶é¢æ¿èˆ‡è¼¸å…¥ --- */
        .control-panel { text-align: center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px solid #edf2f7; }
        
        /* åŠ å¤§æ‰‹æ©Ÿç‰ˆè¼¸å…¥æ¡† */
        input[type="text"], input[type="number"] { padding: 12px 15px; border: 2px solid #e1e4e8; border-radius: 12px; text-align: center; outline: none; font-weight: bold; font-size: 1rem; width: 100px; max-width: 100%; }
        input[type="text"] { width: 140px; text-transform: uppercase; }
        input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        
        .action-btn { background: var(--success); color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: bold; margin-left: 5px; box-shadow: 0 4px 6px rgba(39,174,96,0.2); transition: 0.2s; }
        .action-btn:active { transform: scale(0.96); }

        /* --- ä¸€éµç¯©é¸ (Quick Screener) --- */
        .filter-section { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .filter-btn { background: white; border: 1px solid #dcdfe6; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; color: #555; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .filter-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #f0f7ff; }

        #filter-results-container { display: none; margin-top: 15px; padding: 15px; background: white; border: 1px dashed #ced4da; border-radius: 10px; position: relative; }
        #filter-results-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; }
        .stock-btn { background: #f1f3f5; border: none; color: #333; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
        .stock-btn:hover { background: var(--primary-color); color: white; }

        /* --- æŠ•è³‡çµ„åˆè¡¨æ ¼èˆ‡é è¨­æŒ‰éˆ• --- */
        .portfolio-table { width: 100%; max-width: 100%; margin: 0 auto 15px auto; border-collapse: separate; border-spacing: 0 8px; }
        .portfolio-table td { padding: 0 5px; }
        .portfolio-table input { width: 100%; box-sizing: border-box; }
        .remove-row { color: var(--danger); cursor: pointer; font-size: 1.5rem; line-height: 1; margin-left: 5px; }

        .preset-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .preset-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; opacity: 0.9; }
        .preset-btn:hover { opacity: 1; transform: translateY(-1px); }
        .preset-btn.buffett { background: #27ae60; } /* Green */
        .preset-btn.ark { background: #e74c3c; } /* Red */
        .preset-btn.paris { background: #8e44ad; } /* Purple */

        /* --- åœ–è¡¨èˆ‡åˆ†æå€ --- */
        .content-grid { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 10px; }
        .chart-section { flex: 1 1 100%; min-width: 0; } /* é˜²æ­¢ Chartjs åœ¨ Flexbox ä¸­æº¢å‡º */
        
        .canvas-container { position: relative; width: 100%; height: 380px; margin: 0 auto; } 

        /* Trend Chart å„ªåŒ– */
        .trend-container { margin-top: 25px; background: #fff; border-radius: 16px; border: 1px solid #eee; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: none; }
        .trend-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .trend-title { font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px; }
        .trend-badge { font-size: 0.85em; padding: 4px 10px; border-radius: 6px; font-weight: bold; }
        .status-safe { background: #e8f5e9; color: #2e7d32; }
        .status-danger { background: #ffebee; color: #c62828; }
        .status-neutral { background: #e3f2fd; color: #1565c0; }

        /* åˆ†æé¢æ¿ */
        .insight-section { width: 100%; background: #fff; padding: 25px; border-radius: 15px; border-left: 5px solid var(--primary-color); box-shadow: 0 5px 20px rgba(0,0,0,0.05); display: none; box-sizing: border-box; }
        .insight-title { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: var(--text-main); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .insight-list { padding: 0; list-style: none; margin: 0; }
        .insight-list li { margin-bottom: 12px; font-size: 0.95rem; color: #555; position: relative; padding-left: 25px; }
        .insight-list li::before { content: "ğŸ’¡"; position: absolute; left: 0; top: 2px; }
        .insight-highlight { color: #1a1a1a; font-weight: 700; }

        /* æ¨™ç±¤é›² */
        #tags-container { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .tag { padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .tag.blue { background: #e1f5fe; color: #0277bd; }
        .tag.red { background: #ffebee; color: #c62828; }
        .tag.green { background: #f1f8e9; color: #33691e; }

        /* æ³•å¾‹è²æ˜ */
        .compliance-section { margin-top: 40px; font-size: 0.75rem; color: #999; background: #f8f9fa; padding: 20px; border-radius: 10px; line-height: 1.5; }
        
        @media (min-width: 768px) {
            .chart-section { flex: 0 0 55%; }
            .insight-section { flex: 1; }
            .content-grid { align-items: flex-start; }
            .preset-btn { padding: 8px 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Stock Factor DNA</h1>
        <div class="subtitle">æ©Ÿæ§‹ç´šè¦–é‡ Â· æ•£æˆ¶åŒ–è§£è®€ (Retail Pro Edition)</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('single')">ğŸ” å€‹è‚¡é«”æª¢</button>
        <button class="tab-btn" onclick="switchTab('peer')">âš–ï¸ å…©è‚¡PK</button>
        <button class="tab-btn" onclick="switchTab('portfolio')">ğŸ’¼ çµ„åˆè¨ºæ–·</button>
        <button class="tab-btn" onclick="switchTab('about')">â„¹ï¸ èªªæ˜</button>
    </div>

    <div id="tab-single" class="tab-content active">
        <div class="control-panel">
            <div style="margin-bottom:10px; font-size:0.9em; color:#666;">è¼¸å…¥ç¾è‚¡ä»£è™Ÿ (å¦‚ AAPL)</div>
            <input type="text" id="tickerInput" placeholder="CODE" onkeyup="if(event.key==='Enter') updateSingleChart()">
            <button class="action-btn" onclick="updateSingleChart()">é–‹å§‹åˆ†æ</button>
            
            <div class="filter-section">
                <button onclick="filterStocks('High Quality')" class="filter-btn">ğŸ’ å„ªè³ªè­·åŸæ²³</button>
                <button onclick="filterStocks('Deep Value')" class="filter-btn">ğŸ’° æ·±åº¦åƒ¹å€¼(ä¾¿å®œ)</button>
                <button onclick="filterStocks('High Growth')" class="filter-btn">ğŸš€ é«˜æˆé•·å¤¢æƒ³</button>
                <button onclick="filterStocks('Defensive')" class="filter-btn">ğŸ›¡ï¸ é¿é¢¨æ¸¯é˜²ç¦¦</button>
            </div>
            
            <div id="filter-results-container">
                <span style="position:absolute; top:5px; right:10px; cursor:pointer; font-size:1.2em;" onclick="this.parentElement.style.display='none'">Ã—</span>
                <div style="font-size:0.85em; color:#666; margin-bottom:8px;">é»æ“Šä»¥è¼‰å…¥è‚¡ç¥¨ï¼š</div>
                <div id="filter-results-buttons"></div>
            </div>
        </div>
    </div>

    <div id="tab-peer" class="tab-content">
        <div class="control-panel">
            <div style="margin-bottom:10px; font-size:0.9em; color:#666;">æ¯”è¼ƒå…©æ”¯è‚¡ç¥¨çš„ã€Œæ€§æ ¼ã€å·®ç•°</div>
            <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                <input type="text" id="peerA" placeholder="è‚¡ç¥¨ A" style="width: 100px;">
                <span style="font-weight:bold; color:#999;">VS</span>
                <input type="text" id="peerB" placeholder="è‚¡ç¥¨ B" style="width: 100px;">
            </div>
            <br>
            <button class="action-btn" onclick="updatePeerChart()">é€²è¡Œ PK</button>
        </div>
    </div>

    <div id="tab-portfolio" class="tab-content">
        <div class="control-panel">
            <div style="font-size:0.9em; color:#666; margin-bottom:10px;">ä¸€éµå¥—ç”¨å¤§å¸«æ¨¡çµ„ (çœ‹çœ‹ä»–å€‘è²·ä»€éº¼)</div>
            <div class="preset-group">
                <button class="preset-btn buffett" onclick="loadPreset('buffett')">ğŸ‘´ å·´è²ç‰¹é¢¨æ ¼ (ç©©å¥)</button>
                <button class="preset-btn ark" onclick="loadPreset('ark')">ğŸ‘©â€ğŸ¦° æœ¨é ­å§ ARK (æ¿€é€²)</button>
                <button class="preset-btn paris" onclick="loadPreset('paris')">ğŸ¦Š ParisTrader (å¹³è¡¡)</button>
            </div>
            <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
            
            <table class="portfolio-table" id="portfolioTable">
                <thead><tr><th style="text-align:left;">ä»£è™Ÿ</th><th style="width:80px;">æ¬Šé‡%</th><th></th></tr></thead>
                <tbody>
                    <tr><td><input type="text" class="portfolio-input" value="AAPL"></td><td><input type="number" class="weight-input" value="50"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td></tr>
                    <tr><td><input type="text" class="portfolio-input" value="KO"></td><td><input type="number" class="weight-input" value="50"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td></tr>
                </tbody>
            </table>
            <button onclick="addPortfolioRow()" style="background:#e9ecef; color:#333; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-size:0.9em;">+ æ–°å¢è‚¡ç¥¨</button>
            <br><br>
            <button class="action-btn" onclick="updatePortfolioChart()">è¨ºæ–·æˆ‘çš„çµ„åˆ</button>
        </div>
    </div>

    <div id="tab-about" class="tab-content">
        <div style="background:#fff; padding:25px; border-radius:15px; border:1px solid #eee;">
            <h3 style="color:#007bff; border-bottom:2px solid #f0f0f0; padding-bottom:10px; margin-top:0;">ğŸ“Š é€™æ˜¯ä»€éº¼å·¥å…·ï¼Ÿ</h3>
            <p>é€™æ˜¯å°‡æ©Ÿæ§‹æ³•äººçš„ **Fama-French äº”å› å­æ¨¡å‹** ç°¡åŒ–çµ¦æ•£æˆ¶ä½¿ç”¨çš„ã€ŒXå…‰æ©Ÿã€ã€‚</p>
            <ul style="padding-left:20px; line-height:1.8; color:#555;">
                <li><strong>æ³¢å‹•é¢¨éšª (Beta):</strong> è¶Šé«˜ä»£è¡¨è‚¡åƒ¹è¶Šåƒé›²éœ„é£›è»Šã€‚</li>
                <li><strong>è¦æ¨¡ (Size):</strong> è¶Šå¾€å¤–åœˆä»£è¡¨å¸‚å€¼è¶Šå° (Small Cap)ï¼Œçˆ†ç™¼åŠ›å¼·ä½†é¢¨éšªé«˜ã€‚</li>
                <li><strong>ä¾¿å®œä¼°å€¼ (Value):</strong> åˆ†æ•¸é«˜ä»£è¡¨è‚¡åƒ¹ç›¸å°æ–¼åŸºæœ¬é¢å¾ˆã€Œä¾¿å®œã€(Deep Value)ã€‚</li>
                <li><strong>å‹•èƒ½ (Mom):</strong> åˆ†æ•¸é«˜ä»£è¡¨è¿‘æœŸè‚¡åƒ¹å¼·å‹¢ï¼Œæ­£åœ¨ä¸Šæ¼²è¶¨å‹¢ä¸­ã€‚</li>
                <li><strong>å“è³ª (Quality):</strong> ä»£è¡¨å…¬å¸è³ºéŒ¢èƒ½åŠ›èˆ‡è²¡å‹™é«”è³ªæ˜¯å¦ç©©å¥ã€‚</li>
            </ul>
        </div>
    </div>

    <div class="content-grid" id="main-display-area">
        <div class="chart-section">
            <div class="canvas-container">
                <canvas id="radarChart"></canvas>
            </div>
            <div id="tags-container"></div>
            
            <div id="trend-wrapper" class="trend-container">
                <div class="trend-header">
                    <div class="trend-title">ğŸ’“ é¢¨éšªå¿ƒé›»åœ– (Beta Trend)</div>
                    <div id="trend-badge" class="trend-badge status-neutral">--</div>
                </div>
                <div id="trend-comment" style="font-size:0.9em; color:#666; margin-bottom:10px; background:#f8f9fa; padding:10px; border-radius:8px;"></div>
                <div style="height: 120px; width:100%;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="insight-section" id="insight-panel">
            <div class="insight-title" id="insight-title-text">ğŸ“Š AI è¨ºæ–·å ±å‘Š</div>
            <ul class="insight-list" id="insight-content"></ul>
            <div style="margin-top:20px; text-align:right; font-size:0.8em; color:#999;">
                æ•¸æ“šæ—¥æœŸ: <span id="data-date">Loading...</span>
            </div>
        </div>
    </div>

    <div class="compliance-section">
        <strong>âš ï¸ å…è²¬è²æ˜ (Disclaimer):</strong><br>
        æœ¬å·¥å…·åƒ…ä¾›æ•™å­¸èˆ‡è¼”åŠ©åˆ†æä½¿ç”¨ï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ã€‚å› å­æ•¸æ“šåŸºæ–¼æ­·å²çµ±è¨ˆï¼Œå­˜åœ¨ç´„ 1 å€‹æœˆçš„å­¸è¡“æ»¯å¾Œï¼Œä¸é©åˆä½œç‚ºæ¥µçŸ­ç·šäº¤æ˜“ä¾æ“šã€‚æŠ•è³‡æ¶‰åŠé¢¨éšªï¼Œè«‹è©•ä¼°è‡ªèº«æ‰¿å—èƒ½åŠ›ã€‚Data Source: Kenneth R. French Data Library.
    </div>
</div>

<script>
    let stockData = {};
    let myChart = null;
    let trendChart = null;
    
    // å®šç¾©ã€Œç™½è©±æ–‡ã€è»¸æ¨™ç±¤
    const axisLabels = ['æ³¢å‹•é¢¨éšª (Beta)', 'è‚¡åƒ¹å‹•èƒ½ (Mom)', 'ç²åˆ©å“è³ª (Qual)', 'å¸‚å€¼è¦æ¨¡ (Size)', 'ä¾¿å®œä¼°å€¼ (Val)'];
    
    // å®šç¾©å¤§å¸«æŒå€‰é è¨­
    const presets = {
        'buffett': [['KO', 40], ['AXP', 20], ['BAC', 20], ['CVX', 10], ['KHC', 10]], // ç¯„ä¾‹ï¼šå·´è²ç‰¹æ„›è‚¡
        'ark': [['TSLA', 30], ['COIN', 25], ['ROKU', 25], ['U', 20]], // ç¯„ä¾‹ï¼šæˆé•·å‹
        'paris': [['GOOGL', 50], ['RKLB', 30], ['SLV', 20]] // æ‚¨çš„æŒå€‰
    };

    // åˆå§‹åŒ–
    window.onload = function() {
        Papa.parse("stock_factor_data.csv", {
            download: true, header: true,
            complete: function(results) {
                results.data.forEach(row => { if(row.Ticker) stockData[row.Ticker] = row; });
                if(Object.keys(stockData).length > 0) {
                    // é è¨­è¼‰å…¥ç¬¬ä¸€æ”¯ï¼Œæˆ–ä¿æŒç©ºç™½è®“ä½¿ç”¨è€…è¼¸å…¥
                    // document.getElementById('tickerInput').value = Object.keys(stockData)[0];
                    // updateSingleChart();
                }
            }
        });
    };

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        event.currentTarget.classList.add('active');

        // å¦‚æœæ˜¯é—œæ–¼é ï¼Œéš±è—ä¸‹æ–¹åœ–è¡¨å€
        document.getElementById('main-display-area').style.display = (tabId === 'about') ? 'none' : 'flex';
        
        // é‡ç½®åœ–è¡¨ç‹€æ…‹
        if(tabId === 'single') document.getElementById('trend-wrapper').style.display = 'none';
        if(tabId === 'portfolio') document.getElementById('trend-wrapper').style.display = 'none';
    }

    // --- æ ¸å¿ƒåœ–è¡¨ç¹ªè£½ (å«èƒŒæ™¯å„ªåŒ–) ---
    // è‡ªå®šç¾©æ’ä»¶ï¼šç¹ªè£½é›·é”åœ–èƒŒæ™¯è‰²åœˆ
    const radarBackgroundPlugin = {
        id: 'radarBackground',
        beforeDraw: (chart) => {
            if (chart.config.type !== 'radar') return;
            const ctx = chart.ctx;
            const {r} = chart.scales;
            const xCenter = r.xCenter;
            const yCenter = r.yCenter;
            
            // ç•«ç¶ è‰²å®‰å…¨å€ (0-5åˆ†)
            ctx.save();
            ctx.beginPath();
            ctx.arc(xCenter, yCenter, r.getDistanceFromCenterForValue(5), 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(46, 125, 50, 0.05)'; // æ·¡æ·¡çš„ç¶ 
            ctx.fill();
            
            // ç•«ç´…è‰²æ¥µç«¯å€ (8-10åˆ†) - é€™è£¡ç”¨ç’°å½¢ç•«æ³•æ¯”è¼ƒè¤‡é›œï¼Œç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘åªç•«å¤–åœˆé‚Šç•Œæç¤º
            ctx.beginPath();
            ctx.arc(xCenter, yCenter, r.getDistanceFromCenterForValue(8), 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgba(231, 76, 60, 0.3)'; // æ·¡æ·¡çš„ç´…ç·š
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.restore();
        }
    };

    function renderRadar(datasets) {
        if (myChart) myChart.destroy();
        const ctx = document.getElementById('radarChart').getContext('2d');
        
        myChart = new Chart(ctx, {
            type: 'radar',
            data: { 
                labels: axisLabels, 
                datasets: datasets 
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                scales: { 
                    r: { 
                        min: 0, max: 10,
                        pointLabels: { font: { size: 12, weight: 'bold' }, color: '#333' },
                        grid: { color: '#e0e0e0' },
                        ticks: { display: false } // éš±è—åˆ»åº¦æ•¸å­—ï¼Œæ›´ç°¡æ½”
                    } 
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let val = context.raw;
                                let label = context.dataset.label || '';
                                let comment = "";
                                if(val > 7.5) comment = " (æ¥µé«˜ğŸ”¥)";
                                else if(val < 3) comment = " (åä½ğŸ§Š)";
                                return `${label}: ${val}${comment}`;
                            }
                        }
                    }
                }
            },
            plugins: [radarBackgroundPlugin]
        });
    }

    // --- åŠŸèƒ½é‚è¼¯ ---

    function updateSingleChart() {
        let ticker = document.getElementById('tickerInput').value.toUpperCase().trim();
        let data = stockData[ticker];
        if(!data) { alert('æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼ (å¯èƒ½æœªåœ¨è³‡æ–™åº«ä¸­)'); return; }

        showInsightPanel(ticker, data.Last_Date);
        renderTags(data.Baskets);
        generateInsights(data, 'single');
        
        let scores = getScores(data);
        renderRadar([{ 
            label: ticker, 
            data: scores, 
            borderColor: '#007bff', 
            backgroundColor: 'rgba(0,123,255,0.25)',
            pointBackgroundColor: '#007bff'
        }]);
        
        // è™•ç† Beta Trend
        if (data.Beta_Trend) {
            document.getElementById('trend-wrapper').style.display = 'block';
            renderTrendChart(data.Beta_Trend, ticker);
        } else {
            document.getElementById('trend-wrapper').style.display = 'none';
        }
        document.getElementById('filter-results-container').style.display = 'none';
    }

    function updatePeerChart() {
        let tA = document.getElementById('peerA').value.toUpperCase().trim();
        let tB = document.getElementById('peerB').value.toUpperCase().trim();
        let dataA = stockData[tA]; let dataB = stockData[tB];
        if(!dataA || !dataB) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç¢¼'); return; }

        showInsightPanel(`${tA} vs ${tB}`, dataA.Last_Date);
        document.getElementById('tags-container').innerHTML = ''; 
        document.getElementById('trend-wrapper').style.display = 'none';

        let ul = document.getElementById('insight-content');
        ul.innerHTML = `<li><strong>æ¯”è¼ƒå»ºè­°ï¼š</strong> è§€å¯Ÿé¢ç©é‡ç–Šéƒ¨åˆ†ã€‚è‹¥ B è‚¡å®Œå…¨åŒ…è¦† A è‚¡ï¼Œä»£è¡¨å…¶åœ¨å„å› å­å±¬æ€§ä¸Šéƒ½æ›´å¼·çƒˆã€‚</li>`;
        ul.innerHTML += `<li><strong>${tA}:</strong> é¢¨éšªä¿‚æ•¸ ${dataA.Score_Beta}ï¼Œåƒ¹å€¼åˆ† ${dataA.Score_Value}</li>`;
        ul.innerHTML += `<li><strong>${tB}:</strong> é¢¨éšªä¿‚æ•¸ ${dataB.Score_Beta}ï¼Œåƒ¹å€¼åˆ† ${dataB.Score_Value}</li>`;

        renderRadar([
            { label: tA, data: getScores(dataA), borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)' },
            { label: tB, data: getScores(dataB), borderColor: '#fd7e14', backgroundColor: 'rgba(253,126,20,0.1)' }
        ]);
    }

    // --- æŠ•è³‡çµ„åˆèˆ‡é è¨­åŠŸèƒ½ ---
    function loadPreset(type) {
        let tbody = document.querySelector('#portfolioTable tbody');
        tbody.innerHTML = ''; // æ¸…ç©º
        let items = presets[type];
        if(items) {
            items.forEach(item => {
                let row = tbody.insertRow();
                row.innerHTML = `<td><input type="text" class="portfolio-input" value="${item[0]}"></td><td><input type="number" class="weight-input" value="${item[1]}"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td>`;
            });
            // è‡ªå‹•è§¸ç™¼è¨ˆç®—
            setTimeout(updatePortfolioChart, 100);
        }
    }

    function addPortfolioRow() {
        let table = document.querySelector('#portfolioTable tbody');
        if(table.rows.length >= 10) return;
        let newRow = table.insertRow();
        newRow.innerHTML = `<td><input type="text" class="portfolio-input" value=""></td><td><input type="number" class="weight-input" value="0"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td>`;
    }
    function removeRow(span) { span.parentElement.parentElement.remove(); }

    function updatePortfolioChart() {
        let rows = document.querySelectorAll('#portfolioTable tbody tr');
        let portfolioScores = [0,0,0,0,0]; 
        let totalWeight = 0;
        
        for(let row of rows) {
            let ticker = row.querySelector('.portfolio-input').value.toUpperCase().trim();
            let weight = parseFloat(row.querySelector('.weight-input').value);
            if(!ticker || !stockData[ticker]) continue;
            totalWeight += weight;
            let s = getScores(stockData[ticker]);
            for(let i=0; i<5; i++) portfolioScores[i] += s[i] * (weight/100);
        }

        if(Math.abs(totalWeight - 100) > 1) { alert(`ç›®å‰ç¸½æ¬Šé‡ç‚º ${totalWeight}%ï¼Œè«‹èª¿æ•´è‡³ 100%`); return; }

        showInsightPanel("æˆ‘çš„æŠ•è³‡çµ„åˆ", "åŠ æ¬Šè¨ˆç®—");
        document.getElementById('tags-container').innerHTML = '';
        document.getElementById('trend-wrapper').style.display = 'none';

        // ç”Ÿæˆçµ„åˆå ±å‘Š
        let pfData = { Score_Beta: portfolioScores[0], Score_Mom: portfolioScores[1], Score_Quality: portfolioScores[2], Score_Size: portfolioScores[3], Score_Value: portfolioScores[4] };
        generateInsights(pfData, 'portfolio');

        renderRadar([{ 
            label: 'çµ„åˆ DNA', 
            data: portfolioScores, 
            borderColor: '#8e44ad', 
            backgroundColor: 'rgba(142, 68, 173, 0.25)',
            pointBackgroundColor: '#8e44ad'
        }]);
    }

    // --- å¿ƒé›»åœ– (Beta Trend) ç¹ªè£½èˆ‡è§£è®€ ---
    function renderTrendChart(trendStr, ticker) {
        if (trendChart) trendChart.destroy();
        const ctx = document.getElementById('trendChart').getContext('2d');
        let dataPoints = trendStr.split(',').map(Number);
        
        // å–å¾—æœ€æ–°ä¸€é»çš„æ•¸å€¼
        let currentBeta = dataPoints[dataPoints.length - 1];
        let badge = document.getElementById('trend-badge');
        let commentDiv = document.getElementById('trend-comment');
        
        // å‹•æ…‹ç”Ÿæˆã€Œäººè©±ã€è©•èª
        let msg = "";
        if (currentBeta > 1.3) {
            badge.innerText = "âš ï¸ é«˜é¢¨éšª"; badge.className = "trend-badge status-danger";
            msg = `<strong>${ticker} æ­£åœ¨ç™¼ç‡’ï¼š</strong>ç›®å‰çš„æ³¢å‹•åº¦æ˜¯å¸‚å ´çš„ ${currentBeta} å€ã€‚é€™æ„å‘³è‘—å¦‚æœå¤§ç›¤è·Œ 1%ï¼Œå®ƒå¯èƒ½æœƒè·Œ ${currentBeta}% ä»¥ä¸Šã€‚é€™æ˜¯ä¸€æ”¯ã€Œæ”»æ“Šå‹ã€è‚¡ç¥¨ï¼Œè«‹ç¹«å¥½å®‰å…¨å¸¶ã€‚`;
        } else if (currentBeta < 0.8) {
            badge.innerText = "ğŸ›¡ï¸ é˜²ç¦¦å‹"; badge.className = "trend-badge status-safe";
            msg = `<strong>${ticker} å¾ˆå†·éœï¼š</strong>ç›®å‰çš„æ³¢å‹•åº¦ä½æ–¼å¤§ç›¤ã€‚å¸‚å ´ææ…Œæ™‚ï¼Œå®ƒé€šå¸¸æ¯”è¼ƒæŠ—è·Œï¼Œé©åˆä½œç‚ºè³‡é‡‘é¿é¢¨æ¸¯ã€‚`;
        } else {
            badge.innerText = "âš–ï¸ è·Ÿéš¨å¤§ç›¤"; badge.className = "trend-badge status-neutral";
            msg = `<strong>${ticker} éš¨æ³¢é€æµï¼š</strong>å®ƒçš„é¢¨éšªå±¬æ€§èˆ‡å¤§ç›¤æŒ‡æ•¸ (S&P 500) ç›¸ç•¶æ¥è¿‘ï¼Œèµ°å‹¢ä¸»è¦å—å¸‚å ´æ•´é«”æ°£æ°›å½±éŸ¿ã€‚`;
        }
        commentDiv.innerHTML = msg;

        // ç¹ªåœ–
        let labels = Array.from({length: dataPoints.length}, (_, i) => i);
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Beta',
                    data: dataPoints,
                    borderColor: currentBeta > 1.2 ? '#e74c3c' : '#2ecc71', // ç´…è‰²æˆ–ç¶ è‰²ç·š
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: {
                        target: {value: 1.0},
                        above: 'rgba(231, 76, 60, 0.1)',   // Area above 1.0 (Red)
                        below: 'rgba(46, 125, 50, 0.1)'    // Area below 1.0 (Green)
                    }
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { intersect: false } },
                scales: { x: { display: false }, y: { display: true, suggestedMin: 0.5, suggestedMax: 1.5 } }
            }
        });
    }

    // --- è¼”åŠ©å‡½å¼ ---
    function getScores(d) { return [parseFloat(d.Score_Beta), parseFloat(d.Score_Mom), parseFloat(d.Score_Quality), parseFloat(d.Score_Size), parseFloat(d.Score_Value)]; }
    function showInsightPanel(t, d) { 
        document.getElementById('insight-panel').style.display = 'block'; 
        document.getElementById('insight-title-text').innerText = "ğŸ“Š åˆ†æå ±å‘Š: " + t; 
        document.getElementById('data-date').innerText = d; 
    }
    
    // ç”Ÿæˆæ™ºèƒ½åˆ†ææ–‡å­— (Retail Version)
    function generateInsights(data, mode) {
        const ul = document.getElementById('insight-content'); ul.innerHTML = '';
        const addLi = (title, text) => { 
            let li = document.createElement('li'); 
            li.innerHTML = `<span class="insight-highlight">${title}</span> ${text}`; 
            ul.appendChild(li); 
        };

        let beta = parseFloat(data.Score_Beta);
        let val = parseFloat(data.Score_Value);
        let size = parseFloat(data.Score_Size);
        let qual = parseFloat(data.Score_Quality);
        let mom = parseFloat(data.Score_Mom);

        if (mode === 'portfolio') {
            if (beta > 7) addLi("å¿ƒè‡Ÿå¤ å¤§é¡†å—ï¼Ÿ", "æ‚¨çš„çµ„åˆæ³¢å‹•åº¦å¾ˆé«˜ã€‚åœ¨å¤§ç‰›å¸‚æœƒè³ºå¾ˆçˆ½ï¼Œä½†ç©ºé ­ä¾†è¥²æ™‚æœƒå—é‡å‚·ã€‚å»ºè­°åŠ å…¥ä¸€äº›é˜²ç¦¦å‹é…ç½® (å¦‚ KO, JNJ)ã€‚");
            else if (beta < 4) addLi("é€€ä¼‘é¤Šè€å‹ï¼š", "æ‚¨çš„çµ„åˆéå¸¸ç©©å¥ä¿å®ˆï¼Œæ™šä¸Šç¡å¾—è‘—è¦ºï¼Œä½†åœ¨å¸‚å ´å¤§æ¼²æ™‚ç¸¾æ•ˆå¯èƒ½æœƒè½å¾Œã€‚");
            else addLi("æ”»å®ˆå¹³è¡¡ï¼š", "ç›®å‰çš„é…ç½®ç›¸ç•¶æ¨™æº–ï¼Œæ—¢æœ‰æ”»æ“ŠåŠ›ä¹Ÿæœ‰é˜²è­·ç½©ã€‚");
            
            if (val < 3 && qual < 4) addLi("æ³¨æ„æ³¡æ²«é¢¨éšªï¼š", "æ‚¨æŒæœ‰å¾ˆå¤šã€Œé«˜æœ¬ç›Šæ¯” + ä½ç²åˆ©ã€çš„è‚¡ç¥¨ã€‚é€™æ˜¯å…¸å‹çš„æŠ•æ©Ÿçµ„åˆï¼Œè«‹å¯†åˆ‡é—œæ³¨åˆ©ç‡è®ŠåŒ–ã€‚");
        } else {
            // Beta
            if (beta > 8) addLi("ç˜‹ç‹—æµªè­¦ç¤ºï¼š", "æ³¢å‹•æ¥µå¤§ï¼é€™é¡è‚¡ç¥¨é©åˆçŸ­ç·šæ“ä½œï¼Œé•·æŠ±å®¹æ˜“åƒåé›²éœ„é£›è»Šã€‚");
            else if (beta < 3) addLi("è³‡é‡‘é¿é¢¨æ¸¯ï¼š", "å¸‚å ´å´©ç›¤æ™‚ï¼Œé€™é¡è‚¡ç¥¨é€šå¸¸è·Œå¾—æ¯”è¼ƒå°‘ã€‚");
            
            // Value
            if (val > 8) addLi("æ·±åº¦ç‰¹åƒ¹å“ï¼š", "è‚¡åƒ¹ç›¸å°æ–¼åŸºæœ¬é¢éå¸¸ä¾¿å®œ (Deep Value)ã€‚å¯èƒ½æ˜¯è¢«éŒ¯æ®ºçš„é»ƒé‡‘ï¼Œä¹Ÿå¯èƒ½æ˜¯åƒ¹å€¼é™·é˜±ã€‚");
            if (val < 2) addLi("æ˜‚è²´çš„å¤¢æƒ³ï¼š", "å¸‚å ´çµ¦äºˆæ¥µé«˜ä¼°å€¼ (High Growth)ã€‚è‚¡åƒ¹æ˜¯é æœªä¾†çš„æƒ³åƒç©ºé–“æ”¯æ’ï¼Œè²¡å ±ä¸èƒ½å‡ºéŒ¯ã€‚");
            
            // Quality
            if (qual > 7) addLi("è³‡å„ªç”Ÿé«”è³ªï¼š", "å…¬å¸å¾ˆæœƒè³ºéŒ¢ (High Profitability)ï¼Œè²¡å‹™ç©©å¥ï¼Œé©åˆé•·æœŸå­˜è‚¡ã€‚");
            if (qual < 3) addLi("é«”è³ªè™›å¼±ï¼š", "å…¬å¸ç²åˆ©èƒ½åŠ›ä¸ä½³ã€‚å¦‚æœè‚¡åƒ¹åœ¨æ¼²ï¼Œé€šå¸¸æ˜¯é é¡Œæç‚’ä½œã€‚");

            // Momentum
            if (mom > 8) addLi("äººæ°£ç‹ï¼š", "è¿‘æœŸè‚¡åƒ¹å¼·å‹¢å™´å‡ºï¼Œé †å‹¢äº¤æ˜“è€…æœ€æ„›ã€‚ä½†è¦å°å¿ƒä¹–é›¢éå¤§å›èª¿ã€‚");
            if (mom < 2) addLi("å†·å®®è‚¡ï¼š", "è‚¡åƒ¹è¶¨å‹¢å‘ä¸‹ï¼Œå¸‚å ´ç›®å‰ä¸æ„›å®ƒã€‚é™¤éæ‚¨æ˜¯é€†å‹¢äº¤æ˜“é«˜æ‰‹ï¼Œå¦å‰‡åˆ¥æ€¥è‘—æ¥åˆ€ã€‚");
        }
    }
    
    function filterStocks(c) {
        let div = document.getElementById('filter-results-buttons'); div.innerHTML = '';
        let count = 0;
        for(let t in stockData) {
            if(stockData[t].Baskets && stockData[t].Baskets.includes(c)) {
                let btn = document.createElement('button'); btn.className = 'stock-btn'; btn.innerText = t;
                btn.onclick = function() { document.getElementById('tickerInput').value = t; updateSingleChart(); };
                div.appendChild(btn); count++;
            }
        }
        document.getElementById('filter-results-container').style.display = count ? 'block' : 'none';
        if(count==0) alert('ç›®å‰è³‡æ–™åº«ä¸­ç„¡ç¬¦åˆæ­¤æ¢ä»¶çš„è‚¡ç¥¨');
    }
    
    function renderTags(basketsStr) {
        const container = document.getElementById('tags-container'); container.innerHTML = '';
        if (basketsStr) basketsStr.split(';').forEach(tag => {
            tag = tag.trim();
            let span = document.createElement('span'); 
            span.className = 'tag blue';
            if(tag.includes('Aggressive') || tag.includes('Speculative') || tag.includes('Knife')) span.className = 'tag red';
            if(tag.includes('Quality') || tag.includes('Defensive')) span.className = 'tag green';
            
            // ç¿»è­¯æ¨™ç±¤ (å¯é¸)
            if(tag.includes('High Beta')) tag = "âš¡ é«˜æ³¢å‹•";
            if(tag.includes('Defensive')) tag = "ğŸ›¡ï¸ é˜²ç¦¦å‹";
            if(tag.includes('Small Cap')) tag = "ğŸ£ å°å‹è‚¡";
            if(tag.includes('Large Cap')) tag = "ğŸ˜ å¤§å‹è‚¡";
            if(tag.includes('Deep Value')) tag = "ğŸ’° åƒ¹å€¼è‚¡";
            if(tag.includes('High Growth')) tag = "ğŸš€ æˆé•·è‚¡";
            if(tag.includes('High Quality')) tag = "ğŸ’ é«˜å“è³ª";
            if(tag.includes('Junk')) tag = "âš ï¸ æŠ•æ©Ÿç´š";

            span.innerText = tag; 
            container.appendChild(span);
        });
    }
</script>

</body>
</html>