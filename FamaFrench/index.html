<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Factor DNA: Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        header { text-align: center; margin-bottom: 25px; }
        h1 { margin: 0; color: #1a1a1a; letter-spacing: 1px; }
        .subtitle { color: #666; margin-top: 5px; font-size: 0.95em; }

        /* --- Tab å°èˆª --- */
        .tabs { display: flex; justify-content: center; margin-bottom: 30px; gap: 10px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: #e9ecef; border-radius: 25px; cursor: pointer; font-weight: bold; color: #555; transition: 0.3s; margin-bottom: 5px; }
        .tab-btn.active { background: #007bff; color: white; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
        .tab-btn:hover:not(.active) { background: #dbe2e8; }

        /* --- Tab å…§å®¹å€å¡Š --- */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- è¼¸å…¥æ§åˆ¶é … --- */
        .control-panel { text-align: center; margin-bottom: 25px; position: relative; }
        input[type="text"], input[type="number"] { padding: 12px; border: 2px solid #e1e4e8; border-radius: 10px; text-align: center; outline: none; transition: 0.3s; text-transform: uppercase; font-weight: bold; }
        input:focus { border-color: #007bff; }
        .action-btn { background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        
        /* ç¯©é¸å™¨æ¨£å¼ */
        .filter-section { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .filter-btn { background: white; border: 1px solid #ddd; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.85em; color: #555; transition: 0.2s; }
        .filter-btn:hover { background: #007bff; color: white; border-color: #007bff; }
        #filter-results-container { display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px dashed #ced4da; border-radius: 10px; position: relative; }
        #filter-results-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; }
        .stock-btn { background: #fff; border: 1px solid #007bff; color: #007bff; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .stock-btn:hover { background: #007bff; color: white; }
        .close-filter { position: absolute; top: 5px; right: 10px; cursor: pointer; color: #aaa; font-weight: bold; font-size: 1.2em; }

        /* --- æŠ•è³‡çµ„åˆè¡¨æ ¼ --- */
        .portfolio-table { width: 100%; max-width: 600px; margin: 0 auto 20px auto; border-collapse: collapse; }
        .portfolio-table th { text-align: left; padding: 10px; color: #666; font-size: 0.9em; }
        .portfolio-table td { padding: 5px; }
        .portfolio-input { width: 90%; }
        .weight-input { width: 80px; }
        .remove-row { color: #dc3545; cursor: pointer; font-weight: bold; font-size: 1.2em; }

        /* --- æ ¸å¿ƒå…§å®¹å€ (å·¦å³ä½ˆå±€) --- */
        .content-grid { display: flex; flex-wrap: wrap; gap: 40px; align-items: flex-start; margin-top: 20px; min-height: 500px; }
        .chart-section { flex: 1 1 400px; position: relative; min-width: 300px; }
        
        /* åœ–è¡¨å®¹å™¨ */
        .canvas-container { position: relative; width: 100%; height: 400px; min-height: 400px; } 
        
        /* Beta è¶¨å‹¢åœ–å®¹å™¨ */
        .trend-container { margin-top: 25px; padding: 20px; border: 1px solid #eee; background: #fafafa; border-radius: 12px; height: auto; width: 100%; display: none; box-sizing: border-box; }
        .trend-explainer { font-size: 0.85em; color: #666; margin-bottom: 10px; line-height: 1.4; background: white; padding: 10px; border-radius: 8px; border: 1px dashed #ddd; }
        
        /* æ™ºèƒ½åˆ†æé¢æ¿ */
        .insight-section { flex: 1 1 300px; background: #fff; padding: 25px; border-radius: 15px; border: 1px solid #e1e4e8; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: none; }
        .insight-title { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; color: #007bff; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        .insight-list { list-style: none; padding: 0; margin: 0; }
        .insight-list li { margin-bottom: 15px; font-size: 0.95em; line-height: 1.6; padding-left: 24px; position: relative; color: #444; }
        .insight-list li::before { content: "ğŸ’¡"; position: absolute; left: 0; top: 2px; font-size: 1.1em; }
        .insight-highlight { font-weight: bold; color: #2c3e50; }

        #tags-container { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 600; background: #e3f2fd; color: #1565c0; }
        .tag.blue { background: #e3f2fd; color: #1565c0; }
        .tag.red { background: #ffebee; color: #c62828; }
        .tag.green { background: #e8f5e9; color: #2e7d32; }

        /* --- é—œæ–¼é é¢æ¨£å¼ --- */
        .about-section { background: #f8f9fa; padding: 30px; border-radius: 15px; border: 1px solid #e9ecef; }
        .about-block { margin-bottom: 25px; }
        .about-block h3 { color: #2c3e50; border-bottom: 2px solid #007bff; padding-bottom: 8px; display: inline-block; margin-top: 0; }
        .about-text { color: #555; line-height: 1.8; font-size: 0.95em; }
        .author-card { background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #28a745; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .contact-link { display: inline-block; margin-right: 15px; margin-top: 10px; text-decoration: none; color: white; background-color: #0088cc; padding: 8px 15px; border-radius: 20px; font-weight: bold; transition: 0.2s; font-size: 0.9em; }
        .contact-link:hover { background-color: #0077b5; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,136,204,0.3); }
        .ref-link { color: #007bff; text-decoration: none; font-weight: bold; }

        /* --- åˆè¦å…è²¬è²æ˜ --- */
        .compliance-section { margin-top: 50px; padding: 25px; background-color: #f8f9fa; border-top: 3px solid #e9ecef; border-radius: 8px; font-size: 0.8em; color: #666; line-height: 1.6; text-align: justify; }
        .compliance-section h4 { margin-top: 0; color: #333; font-size: 1.1em; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 10px; }
        .compliance-block { margin-bottom: 15px; }
        .compliance-title { font-weight: bold; color: #444; display: block; margin-bottom: 3px; }
        .data-date-display { float: right; color: #007bff; font-weight: bold; }

        @media (max-width: 768px) { .content-grid { flex-direction: column; } .portfolio-table { width: 100%; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Stock Factor DNA</h1>
        <div class="subtitle">ç¾è‚¡å› å­ç‰¹æ€§åˆ†æ (Beta / Size / Value / Mom / Quality)</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('single')">ğŸ” å€‹è‚¡åˆ†æ</button>
        <button class="tab-btn" onclick="switchTab('peer')">âš–ï¸ åŒæ¥­æ¯”è¼ƒ</button>
        <button class="tab-btn" onclick="switchTab('portfolio')">ğŸ’¼ æŠ•è³‡çµ„åˆè¨ºæ–·</button>
        <button class="tab-btn" onclick="switchTab('about')">â„¹ï¸ é—œæ–¼èˆ‡åƒè€ƒ</button>
    </div>

    <div id="tab-single" class="tab-content active">
        <div class="control-panel">
            <input type="text" id="tickerInput" placeholder="è¼¸å…¥ä»£ç¢¼ (e.g. AAPL)" onkeyup="if(event.key==='Enter') updateSingleChart()">
            <div class="filter-section">
                <button onclick="filterStocks('High Quality')" class="filter-btn">ğŸ’ High Quality</button>
                <button onclick="filterStocks('High Growth')" class="filter-btn">ğŸš€ High Growth</button>
                <button onclick="filterStocks('Deep Value')" class="filter-btn">ğŸ’° Deep Value</button>
                <button onclick="filterStocks('Small Cap')" class="filter-btn">ğŸ£ Small Cap</button>
                <button onclick="filterStocks('Defensive')" class="filter-btn">ğŸ›¡ï¸ Defensive</button>
            </div>
            <div id="filter-results-container">
                <span class="close-filter" onclick="document.getElementById('filter-results-container').style.display='none'">Ã—</span>
                <div style="font-size:0.9em; color:#666; margin-bottom:10px;">è«‹é¸æ“‡è‚¡ç¥¨ï¼š</div>
                <div id="filter-results-buttons"></div>
            </div>
        </div>
    </div>

    <div id="tab-peer" class="tab-content">
        <div class="control-panel">
            <input type="text" id="peerA" placeholder="è‚¡ç¥¨ A" style="width: 120px;">
            <span style="font-weight:bold; margin:0 10px; color:#999;">VS</span>
            <input type="text" id="peerB" placeholder="è‚¡ç¥¨ B" style="width: 120px;">
            <button class="action-btn" onclick="updatePeerChart()">é–‹å§‹æ¯”è¼ƒ</button>
        </div>
    </div>

    <div id="tab-portfolio" class="tab-content">
        <div class="control-panel">
            <table class="portfolio-table" id="portfolioTable">
                <thead><tr><th>è‚¡ç¥¨ä»£ç¢¼</th><th>æ¬Šé‡ %</th><th></th></tr></thead>
                <tbody>
                    <tr><td><input type="text" class="portfolio-input" value="AAPL"></td><td><input type="number" class="weight-input" value="50"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td></tr>
                    <tr><td><input type="text" class="portfolio-input" value="KO"></td><td><input type="number" class="weight-input" value="50"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td></tr>
                </tbody>
            </table>
            <button onclick="addPortfolioRow()" style="background:#007bff; color:white; border:none; padding:5px 15px; border-radius:15px; cursor:pointer;">+ æ–°å¢è‚¡ç¥¨</button>
            <br><br>
            <button class="action-btn" onclick="updatePortfolioChart()">è¨ˆç®—æŠ•è³‡çµ„åˆ DNA</button>
        </div>
    </div>

    <div id="tab-about" class="tab-content">
        <div class="about-section">
            <div class="about-block">
                <h3>ğŸ“š æ¨¡å‹ç†è«–èˆ‡æ•¸æ“šä¾†æº</h3>
                <div class="about-text">
                    <p>æœ¬å·¥å…·çš„æ ¸å¿ƒæ¨¡å‹åŸºæ–¼è«¾è²çˆ¾ç¶“æ¿Ÿå­¸çå¾—ä¸» <strong>Eugene Fama</strong> èˆ‡ <strong>Kenneth French</strong> æ•™æˆæå‡ºçš„å¤šå› å­æ¨¡å‹ (Fama-French Multi-Factor Model)ã€‚è©²æ¨¡å‹èªç‚ºè‚¡ç¥¨çš„å›å ±ä¸¦ééš¨æ©Ÿï¼Œè€Œæ˜¯ç”±å¸‚å ´é¢¨éšª (Beta)ã€è¦æ¨¡ (Size)ã€åƒ¹å€¼ (Value)ã€ç›ˆåˆ©èƒ½åŠ› (Quality/RMW) ç­‰çµæ§‹æ€§å› å­æ‰€é©…å‹•ã€‚</p>
                    <p>æ‰€æœ‰å› å­åŸå§‹æ•¸æ“šå‡ç›´æ¥å¼•ç”¨è‡ªï¼š<br>
                    <strong>Kenneth R. French Data Library</strong><br>
                    <em>Tuck School of Business at Dartmouth College</em><br>
                    <a href="https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html" target="_blank" class="ref-link">ğŸŒ Visit Data Library</a></p>
                </div>
            </div>

            <div class="about-block">
                <h3>ğŸ‘¨â€ğŸ’» é—œæ–¼ä½œè€…</h3>
                <div class="author-card about-text">
                    <p><strong>Developed by ParisTrader</strong></p>
                    <p>è‡´åŠ›æ–¼å°‡æ©Ÿæ§‹ç´šçš„é‡åŒ–åˆ†æå·¥å…·æ™®åŠåŒ–ï¼Œå”åŠ©æŠ•è³‡è€…ä»¥ç§‘å­¸è¦–è§’é€è¦–å¸‚å ´é¢¨éšªèˆ‡æ©Ÿæœƒã€‚</p>
                    <div style="margin-top: 15px;">
                        <a href="https://t.me/algoparistrader" target="_blank" class="contact-link">ğŸ“¢ Telegram Channel</a>
                        <a href="https://t.me/ParisTrader" target="_blank" class="contact-link">ğŸ’¬ PM Contact</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="content-grid" id="main-display-area">
        <div class="chart-section">
            <div class="canvas-container">
                <canvas id="radarChart"></canvas>
            </div>
            
            <div id="trend-wrapper" class="trend-container">
                <div style="font-weight:bold; color:#333; margin-bottom:5px;">ğŸ“‰ æ­·å²æ³¢å‹•é¢¨éšªèµ°å‹¢ (Beta Trend)</div>
                <div class="trend-explainer">
                    <strong>é€™å¼µåœ–æ€éº¼çœ‹ï¼Ÿ</strong><br>
                    æ­¤åœ–é¡¯ç¤ºéå» 2 å¹´è‚¡ç¥¨ç›¸å°æ–¼å¤§ç›¤çš„é¢¨éšªè®ŠåŒ–ã€‚<br>
                    <span style="color:#dc3545; font-weight:bold;">â— ç´…ç·š</span>ï¼šè‚¡ç¥¨å¯¦éš›æ³¢å‹• Beta å€¼ã€‚<br>
                    <span style="color:#666; font-weight:bold;">â— è™›ç·š (1.0)</span>ï¼šå¤§ç›¤åŸºæº–ç·šã€‚<br>
                    è‹¥ç´…ç·šæŒçºŒåœ¨è™›ç·šä¸Šæ–¹ï¼Œä»£è¡¨é¢¨éšªæ¯”å¤§ç›¤é«˜ï¼›åä¹‹å‰‡è¼ƒå®‰å…¨ã€‚
                </div>
                <div style="height: 150px; width:100%;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div id="tags-container"></div>
        </div>

        <div class="insight-section" id="insight-panel">
            <div class="insight-title">
                ğŸ“Š æŠ•è³‡å±¬æ€§æ·±åº¦è§£æ: <span id="insight-title-text">--</span>
            </div>
            <ul class="insight-list" id="insight-content"></ul>
        </div>
    </div>

    <div class="compliance-section">
        <h4>
            é‡è¦æ³•å¾‹è²æ˜åŠå…è²¬æ¢æ¬¾ (Important Legal Notice & Disclaimer)
            <span class="data-date-display" id="data-date">Data Date: Loading...</span>
        </h4>

        <div class="compliance-block">
            <span class="compliance-title">1. ä¸€èˆ¬è²æ˜ (General)</span>
            æœ¬ç¶²ç«™/æ‡‰ç”¨ç¨‹å¼æ‰€æä¾›çš„è³‡è¨Šã€åˆ†æå·¥å…·åŠåœ–è¡¨ï¼ˆä¸‹ç¨±ã€Œæœ¬è³‡æ–™ã€ï¼‰åƒ…ä¾›ä¸€èˆ¬åƒè€ƒåŠæ•™è‚²ç”¨é€”ã€‚æœ¬è³‡æ–™ä¸æ§‹æˆï¼Œäº¦ç„¡æ„ä½œç‚ºï¼Œä¹Ÿä¸æ‡‰è¢«è©®é‡‹ç‚ºä»»ä½•è­‰åˆ¸ã€é‡‘èç”¢å“æˆ–å·¥å…·çš„è¦ç´„ã€æ‹›æ”¬ã€å»ºè­°ã€æ„è¦‹æˆ–ä»»ä½•ä¿è­‰ã€‚æœ¬ç¶²ç«™ä¸¦ç„¡æ„é‡å°ä»»ä½•ç‰¹å®šå¸æ³•ç®¡è½„å€çš„å±…æ°‘åˆ†ç™¼æˆ–ä½¿ç”¨æœ¬è³‡æ–™ï¼Œå¦‚è©²ç­‰åˆ†ç™¼æˆ–ä½¿ç”¨æœƒé•åç•¶åœ°çš„æ³•å¾‹æˆ–è¦ä¾‹ã€‚
        </div>

        <div class="compliance-block">
            <span class="compliance-title">2. ç„¡æŠ•è³‡å»ºè­° (No Investment Advice)</span>
            æœ¬è³‡æ–™ä¸¦éæŠ•è³‡æ„è¦‹ï¼Œäº¦ä¸æ‡‰è¢«è¦–ç‚ºå°ˆæ¥­æŠ•è³‡å»ºè­°ã€‚æœ¬å·¥å…·ç”¢ç”Ÿçš„åˆ†æçµæœæ˜¯åŸºæ–¼æ­·å²æ•¸æ“šçš„é‡åŒ–æ¨¡å‹é‹ç®—ï¼Œä¸¦æœªè€ƒæ…®é–£ä¸‹å€‹äººçš„è²¡å‹™ç‹€æ³ã€æŠ•è³‡ç›®æ¨™ã€é¢¨éšªæ‰¿å—èƒ½åŠ›æˆ–ç‰¹å®šéœ€æ±‚ï¼ˆSuitabilityï¼‰ã€‚é–£ä¸‹åœ¨ä½œå‡ºä»»ä½•æŠ•è³‡æ±ºå®šå‰ï¼Œæ‡‰è‡ªè¡Œè©•ä¼°é¢¨éšªï¼Œä¸¦å»ºè­°è«®è©¢ç¨ç«‹å°ˆæ¥­è²¡å‹™é¡§å•çš„æ„è¦‹ã€‚
        </div>

        <div class="compliance-block">
            <span class="compliance-title">3. æ•¸æ“šåŠæ¨¡å‹é™åˆ¶ (Data & Model Limitations)</span>
            æœ¬åˆ†ææ¡ç”¨ Kenneth French Data Library æä¾›çš„å­¸è¡“å› å­æ•¸æ“šã€‚ä½¿ç”¨è€…æ‡‰æ³¨æ„ï¼š
            (i) <strong>æ•¸æ“šæ»¯å¾Œé¢¨éšªï¼š</strong> å› å­æ•¸æ“šé€šå¸¸æœ‰ 1 è‡³ 1.5 å€‹æœˆçš„æ›´æ–°æ»¯å¾Œï¼Œæ•…åˆ†æçµæœä¸»è¦åæ˜ è‚¡ç¥¨çš„ä¸­é•·æœŸçµæ§‹æ€§ç‰¹å¾µï¼Œè€Œéå³æ™‚å¸‚å ´ç‹€æ…‹ã€‚
            (ii) <strong>æ¨¡å‹é™åˆ¶ï¼š</strong> å› å­åˆ†æåŸºæ–¼æ­·å²å›æ­¸æ¨¡å‹ï¼Œéå¾€è¡¨ç¾ä¸ä»£è¡¨å°‡ä¾†è¡¨ç¾ (Past performance is not indicative of future results)ã€‚
            (iii) <strong>æº–ç¢ºæ€§ï¼š</strong> ä½œè€…å·²ç›¡åŠ›ç¢ºä¿è³‡è¨Šæº–ç¢ºï¼Œä½†ä¸æœƒå°è³‡è¨Šçš„æº–ç¢ºæ€§ã€å®Œæ•´æ€§æˆ–åŠæ™‚æ€§ä½œå‡ºä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºçš„ä¿è­‰ã€‚
        </div>

        <div class="compliance-block">
            <span class="compliance-title">4. é¢¨éšªæŠ«éœ² (Risk Disclosure)</span>
            æŠ•è³‡æ¶‰åŠé¢¨éšªã€‚è­‰åˆ¸åƒ¹æ ¼å¯å‡å¯è·Œï¼Œç”šè‡³è®Šæˆæ¯«ç„¡åƒ¹å€¼ã€‚åœ¨è‹¥å¹²æƒ…æ³ä¸‹ï¼ŒæŠ•è³‡è€…å¯èƒ½æœƒæå¤±å…¨éƒ¨æŠ•è³‡æœ¬é‡‘ã€‚
        </div>
    </div>
</div>

<script>
    let stockData = {};
    let myChart = null;    // é›·é”åœ–
    let trendChart = null; // æŠ˜ç·šåœ–
    
    let lastState = { tab: 'single', singleTicker: '', peerA: '', peerB: '', hasPortfolioRun: false };

    window.onload = function() {
        Papa.parse("stock_factor_data.csv", {
            download: true, header: true,
            complete: function(results) {
                results.data.forEach(row => { if(row.Ticker) stockData[row.Ticker] = row; });
                if(Object.keys(stockData).length > 0) {
                    let first = Object.keys(stockData)[0];
                    document.getElementById('tickerInput').value = first;
                    updateSingleChart();
                }
            }
        });
    };

    function switchTab(tabId) {
        lastState.tab = tabId;
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        event.target.classList.add('active');

        // å¦‚æœåˆ‡æ›åˆ°"é—œæ–¼"é é¢ï¼Œéš±è—ä¸»è¦é¡¯ç¤ºå€ (åœ–è¡¨)
        if (tabId === 'about') {
            document.getElementById('main-display-area').style.display = 'none';
        } else {
            document.getElementById('main-display-area').style.display = 'flex';
            
            // æ¸…ç†åœ–è¡¨
            if(myChart) myChart.destroy();
            if(trendChart) trendChart.destroy();
            
            document.getElementById('insight-panel').style.display = 'none';
            document.getElementById('tags-container').innerHTML = '';
            document.getElementById('trend-wrapper').style.display = 'none'; 

            // æ¢å¾©ç‹€æ…‹
            if (tabId === 'single' && lastState.singleTicker) updateSingleChart(true);
            else if (tabId === 'peer' && lastState.peerA && lastState.peerB) updatePeerChart(true);
            else if (tabId === 'portfolio' && lastState.hasPortfolioRun) updatePortfolioChart();
        }
    }

    // --- å€‹è‚¡åˆ†æ (å«è¶¨å‹¢åœ–) ---
    function updateSingleChart(isRestore = false) {
        let ticker = isRestore ? lastState.singleTicker : document.getElementById('tickerInput').value.toUpperCase().trim();
        if(!isRestore) lastState.singleTicker = ticker;

        let data = stockData[ticker];
        if(!validateStock(ticker, data)) return;

        showInsightPanel(ticker, data.Last_Date);
        renderTags(data.Baskets);
        generateInsights(data, 'single');
        
        let scores = getScores(data);
        renderRadar([{ label: ticker, data: scores, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.2)' }]);
        
        if (data.Beta_Trend) {
            document.getElementById('trend-wrapper').style.display = 'block';
            renderTrendChart(data.Beta_Trend);
        } else {
            document.getElementById('trend-wrapper').style.display = 'none';
        }

        document.getElementById('filter-results-container').style.display = 'none';
    }

    // --- åŒæ¥­æ¯”è¼ƒ ---
    function updatePeerChart(isRestore = false) {
        let tA = isRestore ? lastState.peerA : document.getElementById('peerA').value.toUpperCase().trim();
        let tB = isRestore ? lastState.peerB : document.getElementById('peerB').value.toUpperCase().trim();
        if(!isRestore) { lastState.peerA = tA; lastState.peerB = tB; }

        let dataA = stockData[tA]; let dataB = stockData[tB];
        if(!validateStock(tA, dataA) || !validateStock(tB, dataB)) return;

        showInsightPanel(`${tA} vs ${tB}`, dataA.Last_Date);
        document.getElementById('tags-container').innerHTML = ''; 
        document.getElementById('trend-wrapper').style.display = 'none';

        let ul = document.getElementById('insight-content');
        ul.innerHTML = `<li><strong>æ¯”è¼ƒæ¨¡å¼å»ºè­°ï¼š</strong> è§€å¯Ÿå…©æ¢ç·šçš„ã€Œé¢ç©å·®ç•°ã€ã€‚é¢ç©è¶Šå¤§ä»£è¡¨å› å­ç‰¹å¾µè¶Šæ¥µç«¯ã€‚</li>`;
        ul.innerHTML += `<li><strong>${tA}:</strong> æ³¢å‹•åº¦ ${dataA.Score_Beta}/10ï¼Œåƒ¹å€¼å±¬æ€§ ${dataA.Score_Value}/10ã€‚</li>`;
        ul.innerHTML += `<li><strong>${tB}:</strong> æ³¢å‹•åº¦ ${dataB.Score_Beta}/10ï¼Œåƒ¹å€¼å±¬æ€§ ${dataB.Score_Value}/10ã€‚</li>`;

        renderRadar([
            { label: tA, data: getScores(dataA), borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)' },
            { label: tB, data: getScores(dataB), borderColor: '#fd7e14', backgroundColor: 'rgba(253,126,20,0.1)' }
        ]);
    }

    // --- æŠ•è³‡çµ„åˆ ---
    function addPortfolioRow() {
        let table = document.getElementById('portfolioTable').getElementsByTagName('tbody')[0];
        if(table.rows.length >= 10) return;
        let newRow = table.insertRow();
        newRow.innerHTML = `<td><input type="text" class="portfolio-input"></td><td><input type="number" class="weight-input" value="0"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td>`;
    }
    function removeRow(span) { span.parentElement.parentElement.remove(); }

    function updatePortfolioChart() {
        let rows = document.querySelectorAll('#portfolioTable tbody tr');
        let portfolioScores = [0,0,0,0,0]; 
        let totalWeight = 0;
        
        for(let row of rows) {
            let ticker = row.querySelector('.portfolio-input').value.toUpperCase().trim();
            let weight = parseFloat(row.querySelector('.weight-input').value);
            if(!ticker || !stockData[ticker]) continue;
            totalWeight += weight;
            let s = getScores(stockData[ticker]);
            for(let i=0; i<5; i++) portfolioScores[i] += s[i] * (weight/100);
        }

        if(Math.abs(totalWeight - 100) > 0.5) { alert(`ç¸½æ¬Šé‡éœ€ç‚º 100%`); return; }

        lastState.hasPortfolioRun = true;
        showInsightPanel("My Portfolio", "Weighted Average");
        document.getElementById('tags-container').innerHTML = '';
        document.getElementById('trend-wrapper').style.display = 'none';

        let pfData = { Score_Beta: portfolioScores[0], Score_Mom: portfolioScores[1], Score_Quality: portfolioScores[2], Score_Size: portfolioScores[3], Score_Value: portfolioScores[4] };
        generateInsights(pfData, 'portfolio');

        renderRadar([{ label: 'Portfolio DNA', data: portfolioScores, borderColor: '#6f42c1', backgroundColor: 'rgba(111, 66, 193, 0.2)' }]);
    }

    // --- åœ–è¡¨ç¹ªè£½ ---
    function renderRadar(datasets) {
        if (myChart) myChart.destroy();
        const ctx = document.getElementById('radarChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'radar',
            data: { labels: ['Market Beta (æ³¢å‹•)', 'Momentum (å‹•èƒ½)', 'Quality (å“è³ª)', 'Size (å°ç›¤)', 'Value (åƒ¹å€¼)'], datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { suggestedMin: 0, suggestedMax: 10, angleLines: { color: '#eee' }, grid: { color: '#eee' } } }
            }
        });
    }

    const horizontalLinePlugin = {
        id: 'horizontalLine',
        beforeDraw: (chart) => {
            if (chart.config.type !== 'line') return;
            const ctx = chart.ctx;
            const yAxis = chart.scales.y;
            const yValue = yAxis.getPixelForValue(1.0);
            
            ctx.save(); ctx.strokeStyle = '#666'; ctx.lineWidth = 1; ctx.setLineDash([5, 5]); 
            ctx.beginPath(); ctx.moveTo(chart.scales.x.left, yValue); ctx.lineTo(chart.scales.x.right, yValue);
            ctx.stroke(); ctx.restore();
        }
    };

    function renderTrendChart(trendStr) {
        if (trendChart) trendChart.destroy();
        const ctx = document.getElementById('trendChart').getContext('2d');
        let dataPoints = trendStr.split(',').map(Number);
        let labels = Array.from({length: dataPoints.length}, (_, i) => i - dataPoints.length + 1);

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Beta Trend',
                    data: dataPoints,
                    borderColor: '#dc3545',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { intersect: false } },
                scales: { 
                    x: { display: false }, 
                    y: { grid: { display: false }, suggestedMin: 0.5, suggestedMax: 1.5 } 
                }
            },
            plugins: [horizontalLinePlugin]
        });
    }

    // --- è¼”åŠ©å‡½å¼ ---
    function getScores(data) { return [parseFloat(data.Score_Beta), parseFloat(data.Score_Mom), parseFloat(data.Score_Quality), parseFloat(data.Score_Size), parseFloat(data.Score_Value)]; }
    function validateStock(t, d) { if(!d) return false; return true; }
    function showInsightPanel(t, d) { document.getElementById('insight-panel').style.display = 'block'; document.getElementById('insight-title-text').innerText = t; document.getElementById('data-date').innerText = `Ref: ${d}`; }
    
    // --- å„ªåŒ–ç‰ˆæ™ºèƒ½åˆ†æ (åŒ…å«ä¸­é–“å€¼è©•åƒ¹) ---
    function generateInsights(data, mode) {
        const ul = document.getElementById('insight-content'); ul.innerHTML = '';
        const addLi = (title, text) => { 
            let li = document.createElement('li'); 
            li.innerHTML = `<span class="insight-highlight">${title}</span> ${text}`; 
            ul.appendChild(li); 
        };

        let beta = parseFloat(data.Score_Beta);
        let val = parseFloat(data.Score_Value);
        let size = parseFloat(data.Score_Size);
        let qual = parseFloat(data.Score_Quality);
        let mom = parseFloat(data.Score_Mom);
        let hasComment = false;

        if (mode === 'portfolio') {
            if (beta > 7) { addLi("é«˜é¢¨éšªè­¦ç¤º:", "æ‚¨çš„æŠ•è³‡çµ„åˆæ³¢å‹•åŠ‡çƒˆã€‚å»ºè­°åœ¨å¸‚å ´éœ‡ç›ªæ™‚æ¸›å°‘æ§“æ¡¿ï¼Œæˆ–åŠ å…¥å…¬ç”¨äº‹æ¥­ã€å¿…éœ€æ¶ˆè²»å“è‚¡ç¥¨ä¾†å¹³è¡¡ã€‚"); hasComment=true; }
            else if (beta < 4) { addLi("ä¿å®ˆé˜²ç¦¦å‹:", "çµ„åˆæ³¢å‹•å¾ˆä½ï¼Œé›–ç„¶å®‰å…¨ï¼Œä½†åœ¨å¤§ç‰›å¸‚ä¸­å¯èƒ½æœƒè·‘è¼¸å¤§ç›¤ã€‚é©åˆé€€ä¼‘è¦åŠƒæˆ–ä½é¢¨éšªæ‰¿å—è€…ã€‚"); hasComment=true; }
            else { addLi("å¹³è¡¡å‹é…ç½®:", "ç›®å‰çš„é¢¨éšªæ°´å¹³é©ä¸­ï¼Œé©åˆé•·æœŸæŒæœ‰ã€‚"); hasComment=true; }

            if (val < 3 && qual < 4) { addLi("é¢¨æ ¼éåº¦é›†ä¸­:", "æ‚¨æŒæœ‰å¤§é‡ã€Œé«˜ä¼°å€¼ + ä½ç²åˆ©ã€çš„æˆé•·è‚¡ã€‚é€™é¡è‚¡ç¥¨å°åˆ©ç‡éå¸¸æ•æ„Ÿï¼Œè«‹å¯†åˆ‡é—œæ³¨è¯æº–æœƒæ”¿ç­–ã€‚"); hasComment=true; }
        } else {
            // Beta
            if (beta > 8.0) { addLi("æ¥µé«˜æ³¢å‹• (Beta > 1.5):", "é€™æ˜¯ä¸€æ”¯ã€Œå¿ƒè·³è‚¡ã€ã€‚å¤§ç›¤è·Œ 1%ï¼Œå®ƒå¯èƒ½è·Œ 2% ä»¥ä¸Šã€‚ä¸å»ºè­°é‡å€‰ï¼Œä¸”å‹™å¿…è¨­å®šåš´æ ¼çš„æ­¢æé»ã€‚"); hasComment=true; }
            else if (beta < 3.0) { addLi("é¿é¢¨æ¸¯å±¬æ€§:", "é€™æ”¯è‚¡ç¥¨èµ°å‹¢èˆ‡å¤§ç›¤é—œè¯ä½ï¼Œç”šè‡³åœ¨å¤§ç›¤ä¸‹è·Œæ™‚èƒ½æŠ—è·Œã€‚é©åˆåœ¨å¸‚å ´ææ…Œæ™‚è²·å…¥ä¿å€¼ã€‚"); hasComment=true; }
            else if (beta >= 4.0 && beta <= 6.0) { addLi("è·Ÿéš¨å¤§ç›¤:", "æ­¤è‚¡ç¥¨çš„æ³¢å‹•é¢¨éšªèˆ‡å¤§ç›¤æŒ‡æ•¸ç›¸è¿‘ï¼Œå±¬æ–¼æ¨™æº–çš„å¸‚å ´é¢¨éšªæš´éœ²ã€‚"); hasComment=true; }

            // Value vs Growth
            if (val > 7.0) { addLi("æ·±åº¦åƒ¹å€¼ (Deep Value):", "è‚¡åƒ¹ç›¸å°æ–¼å…¬å¸è³‡ç”¢éå¸¸ä¾¿å®œã€‚å¸‚å ´å¯èƒ½éåº¦æ‚²è§€ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯ã€Œåƒ¹å€¼é™·é˜±ã€ã€‚"); hasComment=true; }
            else if (val < 2.5) { addLi("é«˜æˆé•·å¤¢æƒ³ (High Growth):", "å¸‚å ´çµ¦äºˆæ¥µé«˜ä¼°å€¼ï¼Œçœ‹å¥½æœªä¾†çˆ†ç™¼åŠ›ã€‚é€™é¡è‚¡ç¥¨éœ€è¦å…¬å¸æŒçºŒäº¤å‡ºè¶…é æœŸçš„è²¡å ±ã€‚"); hasComment=true; }
            else if (val >= 2.5 && val <= 5.0) { addLi("åˆç†æˆé•· (GARP):", "ä¼°å€¼é›–ä¸ä¾¿å®œï¼Œä½†ç›¸å°æ–¼å…¶æˆé•·æ€§ä¾†èªªå°šå±¬åˆç†ã€‚é€™æ˜¯è¨±å¤šå„ªè³ªç§‘æŠ€æ¬Šå€¼è‚¡çš„ç‰¹å¾µã€‚"); hasComment=true; }

            // Quality
            if (qual > 7.0) { addLi("é«˜å“è³ªè­·åŸæ²³:", "å…¬å¸ç²åˆ©èƒ½åŠ›å¼·ã€è²¡å‹™ç©©å¥ (High ROE)ã€‚é€™é¡è‚¡ç¥¨é€šå¸¸æ˜¯é•·æœŸæŠ•è³‡çš„æ ¸å¿ƒé…ç½®é¦–é¸ã€‚"); hasComment=true; }
            else if (qual < 3.0) { addLi("æŠ•æ©Ÿå±¬æ€§è­¦å‘Š:", "å…¬å¸ç²åˆ©ä¸ç©©ç”šè‡³è™§æã€‚è‚¡åƒ¹ä¸Šæ¼²ä¸»è¦é æ¶ˆæ¯é¢æˆ–å¸‚å ´æƒ…ç·’é©…å‹•ã€‚"); hasComment=true; }

            // Momentum
            if (mom > 8.5) { addLi("å¼·å‹¢å™´å‡ºä¸­:", "è¿‘æœŸèµ°å‹¢æ¥µå¼·ã€‚é †å‹¢äº¤æ˜“è€…å¯ä»¥çºŒæŠ±ï¼Œä½†è¦æ³¨æ„ã€Œä¹–é›¢ç‡ã€æ˜¯å¦éå¤§ã€‚"); hasComment=true; }
            else if (mom < 1.5) { addLi("æ¥é£›åˆ€è­¦ç¤º:", "è‚¡åƒ¹æ­£è™•æ–¼è‡ªç”±è½é«”æˆ–é•·æœŸå¼±å‹¢ã€‚åœ¨çœ‹åˆ°æ‰“åº•è¨Šè™Ÿå‰ï¼Œä¸å»ºè­°é€²å ´æŠ„åº•ã€‚"); hasComment=true; }
            
            // Size
            if (size < 3.0) { addLi("å·¨å‹æ¬Šå€¼è‚¡:", "å¸‚å€¼æ¥µå¤§ï¼Œæµå‹•æ€§æ¥µä½³ï¼Œé€šå¸¸æ˜¯æ©Ÿæ§‹æ³•äººçš„æ ¸å¿ƒæŒå€‰ã€‚"); hasComment=true; }

            // Fallback
            if (!hasComment) {
                addLi("å‡è¡¡ç™¼å±•å‹:", "æ­¤è‚¡ç¥¨åœ¨å„é …å› å­ä¸Šè¡¨ç¾ä¸­è¦ä¸­çŸ©ï¼Œæ²’æœ‰æ¥µç«¯çš„é¢¨éšªæˆ–é¢¨æ ¼å‚¾å‘ã€‚é€™é€šå¸¸ä»£è¡¨å®ƒæ˜¯ä¸€æ”¯æˆç†Ÿã€ç©©å®šçš„å…¬å¸ï¼Œé©åˆåšç‚ºæŠ•è³‡çµ„åˆçš„åŸºçŸ³ã€‚");
            }
        }
    }
    
    function filterStocks(c) {
        let div = document.getElementById('filter-results-buttons'); div.innerHTML = '';
        let count = 0;
        for(let t in stockData) {
            if(stockData[t].Baskets && stockData[t].Baskets.includes(c)) {
                let btn = document.createElement('button'); btn.className = 'stock-btn'; btn.innerText = t;
                btn.onclick = function() { document.getElementById('tickerInput').value = t; updateSingleChart(); };
                div.appendChild(btn); count++;
            }
        }
        document.getElementById('filter-results-container').style.display = count ? 'block' : 'none';
        if(count==0) alert('ç„¡ç¬¦åˆçµæœ');
    }
    
    function renderTags(basketsStr) {
        const container = document.getElementById('tags-container'); container.innerHTML = '';
        if (basketsStr) basketsStr.split(';').forEach(tag => {
            let span = document.createElement('span'); span.className = 'tag blue';
            tag = tag.trim();
            if(tag.includes('Aggressive') || tag.includes('Speculative') || tag.includes('Knife')) span.className = 'tag red';
            if(tag.includes('Quality') || tag.includes('Defensive')) span.className = 'tag green';
            span.innerText = tag; container.appendChild(span);
        });
    }
</script>

</body>
</html>