<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Stock Factor DNA: Retail Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* --- 1. åŸæœ‰æ¨£å¼ (å®Œå…¨ä¿æŒä¸è®Š) --- */
        :root { --primary-color: #007bff; --bg-color: #f4f7f6; --card-bg: #ffffff; --text-main: #2c3e50; --text-sub: #7f8c8d; --danger: #e74c3c; --success: #27ae60; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; color: var(--text-main); line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card-bg); padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; color: #1a1a1a; letter-spacing: 1px; font-size: 1.8rem; }
        .subtitle { color: var(--text-sub); margin-top: 8px; font-size: 0.95em; }
        
        .tabs { display: flex; justify-content: center; margin-bottom: 25px; gap: 8px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 18px; border: none; background: #eef2f5; border-radius: 20px; cursor: pointer; font-weight: 600; color: #666; transition: 0.2s; font-size: 0.9rem; flex: 1 1 auto; max-width: 150px; }
        .tab-btn.active { background: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(0,123,255,0.25); }
        .tab-btn:hover:not(.active) { background: #dbe2e8; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .control-panel { text-align: center; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px solid #edf2f7; }
        input[type="text"], input[type="number"] { padding: 12px 15px; border: 2px solid #e1e4e8; border-radius: 12px; text-align: center; outline: none; font-weight: bold; font-size: 1rem; width: 100px; max-width: 100%; }
        input[type="text"] { width: 140px; text-transform: uppercase; }
        input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .action-btn { background: var(--success); color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: bold; margin-left: 5px; box-shadow: 0 4px 6px rgba(39,174,96,0.2); transition: 0.2s; }
        .action-btn:active { transform: scale(0.96); }

        .filter-section { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .filter-btn { background: white; border: 1px solid #dcdfe6; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; color: #555; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .filter-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #f0f7ff; }
        #filter-results-container { display: none; margin-top: 15px; padding: 15px; background: white; border: 1px dashed #ced4da; border-radius: 10px; position: relative; }
        #filter-results-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; }
        .stock-btn { background: #f1f3f5; border: none; color: #333; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
        .stock-btn:hover { background: var(--primary-color); color: white; }

        .portfolio-table { width: 100%; max-width: 100%; margin: 0 auto 15px auto; border-collapse: separate; border-spacing: 0 8px; }
        .portfolio-table td { padding: 0 5px; }
        .portfolio-table input { width: 100%; box-sizing: border-box; }
        .remove-row { color: var(--danger); cursor: pointer; font-size: 1.5rem; line-height: 1; margin-left: 5px; }
        .preset-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .preset-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; opacity: 0.9; }
        .preset-btn:hover { opacity: 1; transform: translateY(-1px); }
        .preset-btn.buffett { background: #27ae60; } .preset-btn.ark { background: #e74c3c; } .preset-btn.paris { background: #8e44ad; }

        .content-grid { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 10px; }
        .chart-section { flex: 1 1 100%; min-width: 0; }
        .canvas-container { position: relative; width: 100%; height: 380px; margin: 0 auto; } 
        .trend-container { margin-top: 25px; background: #fff; border-radius: 16px; border: 1px solid #eee; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: none; }
        .trend-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .trend-title { font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px; }
        .trend-badge { font-size: 0.85em; padding: 4px 10px; border-radius: 6px; font-weight: bold; }
        .status-safe { background: #e8f5e9; color: #2e7d32; } .status-danger { background: #ffebee; color: #c62828; } .status-neutral { background: #e3f2fd; color: #1565c0; }
        .insight-section { width: 100%; background: #fff; padding: 25px; border-radius: 15px; border-left: 5px solid var(--primary-color); box-shadow: 0 5px 20px rgba(0,0,0,0.05); display: none; box-sizing: border-box; }
        .insight-title { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: var(--text-main); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .insight-list { padding: 0; list-style: none; margin: 0; }
        .insight-list li { margin-bottom: 12px; font-size: 0.95rem; color: #555; position: relative; padding-left: 25px; }
        .insight-list li::before { content: "ğŸ’¡"; position: absolute; left: 0; top: 2px; }
        .insight-highlight { color: #1a1a1a; font-weight: 700; }
        #tags-container { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .tag { padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .tag.blue { background: #e1f5fe; color: #0277bd; } .tag.red { background: #ffebee; color: #c62828; } .tag.green { background: #f1f8e9; color: #33691e; }
        .compliance-section { margin-top: 40px; font-size: 0.75rem; color: #999; background: #f8f9fa; padding: 20px; border-radius: 10px; line-height: 1.5; }
        
        @media (min-width: 768px) { .chart-section { flex: 0 0 55%; } .insight-section { flex: 1; } .content-grid { align-items: flex-start; } .preset-btn { padding: 8px 20px; } }

        /* --- [NEW] ç›¸é—œæ€§çŸ©é™£æ¨£å¼ --- */
        .corr-controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .corr-input { width: 300px !important; text-align: left !important; }
        .corr-table-wrapper { overflow-x: auto; border: 1px solid #eee; border-radius: 10px; margin-top: 15px; background: #fff; }
        .corr-table { width: 100%; border-collapse: collapse; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; }
        .corr-table th, .corr-table td { padding: 12px; text-align: center; border: 1px solid #f4f7f6; }
        .corr-table th { background-color: #f8f9fa; color: #2c3e50; font-weight: 700; white-space: nowrap; position: sticky; top: 0; }
        .corr-table td:first-child { font-weight: bold; background-color: #fcfcfc; position: sticky; left: 0; border-right: 2px solid #eee; z-index: 10; }
        .corr-legend { font-size: 0.8rem; color: #999; margin-top: 10px; text-align: right; }
        
        /* [NEW] Correlation Summary Styles */
        .corr-summary { text-align: left; margin-bottom: 20px; display: none; }
        .corr-summary-box { padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .corr-summary-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .corr-summary-text { font-size: 0.95rem; }
        .corr-high { background: #ffebee; border: 1px solid #ffcdd2; color: #c62828; }
        .corr-mid { background: #fff3e0; border: 1px solid #ffe0b2; color: #ef6c00; }
        .corr-low { background: #e8f5e9; border: 1px solid #c8e6c9; color: #2e7d32; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Stock Factor DNA</h1>
        <div class="subtitle">æ©Ÿæ§‹ç´šè¦–é‡ Â· ç°¡å–®è§£è®€</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('single')">ğŸ” å€‹è‚¡é«”æª¢</button>
        <button class="tab-btn" onclick="switchTab('peer')">âš–ï¸ å…©è‚¡PK</button>
        <button class="tab-btn" onclick="switchTab('portfolio')">ğŸ’¼ çµ„åˆè¨ºæ–·</button>
        <button class="tab-btn" onclick="switchTab('correlation')">ğŸ”— ç›¸é—œæ€§çŸ©é™£</button>
        <button class="tab-btn" onclick="switchTab('about')">â„¹ï¸ èªªæ˜</button>
    </div>

    <div id="tab-single" class="tab-content active">
        <div class="control-panel">
            <div style="margin-bottom:10px; font-size:0.9em; color:#666;">è¼¸å…¥ç¾è‚¡ä»£è™Ÿ (å¦‚ AAPL)</div>
            <input type="text" id="tickerInput" placeholder="CODE" onkeyup="if(event.key==='Enter') updateSingleChart()">
            <button class="action-btn" onclick="updateSingleChart()">é–‹å§‹åˆ†æ</button>
            <div class="filter-section">
                <button onclick="filterStocks('High Quality')" class="filter-btn">ğŸ’ å„ªè³ªè­·åŸæ²³</button>
                <button onclick="filterStocks('Deep Value')" class="filter-btn">ğŸ’° æ·±åº¦åƒ¹å€¼</button>
                <button onclick="filterStocks('High Growth')" class="filter-btn">ğŸš€ é«˜æˆé•·</button>
                <button onclick="filterStocks('Defensive')" class="filter-btn">ğŸ›¡ï¸ é˜²ç¦¦å‹</button>
                <button onclick="filterStocks('High Beta')" class="filter-btn">âš¡ é«˜æ³¢å‹•</button>
            </div>
            <div id="filter-results-container">
                <span style="position:absolute; top:5px; right:10px; cursor:pointer; font-size:1.2em;" onclick="this.parentElement.style.display='none'">Ã—</span>
                <div style="font-size:0.85em; color:#666; margin-bottom:8px;">é»æ“Šä»¥è¼‰å…¥è‚¡ç¥¨ï¼š</div>
                <div id="filter-results-buttons"></div>
            </div>
        </div>
    </div>

    <div id="tab-peer" class="tab-content">
        <div class="control-panel">
            <div style="margin-bottom:10px; font-size:0.9em; color:#666;">æ¯”è¼ƒå…©æ”¯è‚¡ç¥¨çš„ã€Œæ€§æ ¼ã€å·®ç•°</div>
            <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                <input type="text" id="peerA" placeholder="è‚¡ç¥¨ A" style="width: 100px;">
                <span style="font-weight:bold; color:#999;">VS</span>
                <input type="text" id="peerB" placeholder="è‚¡ç¥¨ B" style="width: 100px;">
            </div>
            <br>
            <button class="action-btn" onclick="updatePeerChart()">é€²è¡Œ PK</button>
        </div>
    </div>

    <div id="tab-portfolio" class="tab-content">
        <div class="control-panel">
            <div style="font-size:0.9em; color:#666; margin-bottom:10px;">ä¸€éµå¥—ç”¨å¤§å¸«æ¨¡çµ„</div>
            <div class="preset-group">
                <button class="preset-btn buffett" onclick="loadPreset('buffett')">ğŸ‘´ å·´è²ç‰¹é¢¨æ ¼</button>
                <button class="preset-btn ark" onclick="loadPreset('ark')">ğŸ‘©â€ğŸ¦° æœ¨é ­å§ ARK</button>
                <button class="preset-btn paris" onclick="loadPreset('paris')">ğŸ¦Š ParisTrader</button>
            </div>
            <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
            <table class="portfolio-table" id="portfolioTable">
                <thead><tr><th style="text-align:left;">ä»£è™Ÿ</th><th style="width:80px;">æ¬Šé‡%</th><th></th></tr></thead>
                <tbody>
                    <tr><td><input type="text" class="portfolio-input" value="AAPL"></td><td><input type="number" class="weight-input" value="50"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td></tr>
                    <tr><td><input type="text" class="portfolio-input" value="KO"></td><td><input type="number" class="weight-input" value="50"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td></tr>
                </tbody>
            </table>
            <button onclick="addPortfolioRow()" style="background:#e9ecef; color:#333; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-size:0.9em;">+ æ–°å¢è‚¡ç¥¨</button>
            <br><br>
            <button class="action-btn" onclick="updatePortfolioChart()">è¨ºæ–·æˆ‘çš„çµ„åˆ</button>
        </div>
    </div>

    <div id="tab-correlation" class="tab-content">
        <div class="control-panel">
            <div style="margin-bottom:10px; font-size:0.9em; color:#666;">
                è¼¸å…¥ä»£è™Ÿ (é€—è™Ÿåˆ†éš”)ï¼Œè¨ˆç®—é€£å‹•æ€§çŸ©é™£ã€‚<br>
                <span style="font-size:0.8em">ğŸ’¡ å°æç¤º: é¿å…æŠ•è³‡çµ„åˆä¸­éƒ½æ˜¯ç´…è‰² (é«˜åº¦æ­£ç›¸é—œ) çš„è³‡ç”¢ã€‚</span>
            </div>
            <div class="corr-controls">
                <input type="text" id="corrInput" class="corr-input" value="GOOGL,RKLB,SLV,ALB,RTX,STT,AVGO,SOFI" onkeyup="if(event.key==='Enter') calculateCorrelation()">
                <button class="action-btn" onclick="calculateCorrelation()">è¨ˆç®—ç›¸é—œæ€§</button>
            </div>
            
            <div id="corr-summary" class="corr-summary"></div>

            <div class="corr-table-wrapper" id="correlation-container">
                <div style="text-align:center; padding: 40px; color:#bdc3c7;">è«‹è¼¸å…¥ä»£è™Ÿä¸¦é»æ“Šè¨ˆç®—...</div>
            </div>
            
            <div class="corr-legend">
                <span style="color:#e74c3c; font-weight:bold;">ç´…è‰² (>0.7)</span>: é«˜åº¦ç›¸é—œ | 
                <span style="color:#27ae60; font-weight:bold;">ç¶ è‰² (<0)</span>: è² ç›¸é—œ
            </div>
        </div>
    </div>

    <div id="tab-about" class="tab-content">
        <div style="background:#fff; padding:25px; border-radius:15px; border:1px solid #eee;">
            <h3 style="color:#007bff; border-bottom:2px solid #f0f0f0; padding-bottom:10px; margin-top:0;">ğŸ“Š é€™æ˜¯ä»€éº¼å·¥å…·ï¼Ÿ</h3>
            <p>é€™æ˜¯å°‡æ©Ÿæ§‹æ³•äººçš„ **Fama-French äº”å› å­æ¨¡å‹** ç°¡åŒ–çµ¦æ•£æˆ¶ä½¿ç”¨çš„ã€ŒXå…‰æ©Ÿã€ã€‚</p>
            <ul style="padding-left:20px; line-height:1.8; color:#555;">
                <li><strong>æ³¢å‹•é¢¨éšª (Beta):</strong> è¶Šé«˜ä»£è¡¨è‚¡åƒ¹è¶Šåƒé›²éœ„é£›è»Šã€‚</li>
                <li><strong>è¦æ¨¡ (Size):</strong> è¶Šå¾€å¤–åœˆä»£è¡¨å¸‚å€¼è¶Šå° (Small Cap)ï¼Œçˆ†ç™¼åŠ›å¼·ä½†é¢¨éšªé«˜ã€‚</li>
                <li><strong>ä¾¿å®œä¼°å€¼ (Value):</strong> åˆ†æ•¸é«˜ä»£è¡¨è‚¡åƒ¹ç›¸å°æ–¼åŸºæœ¬é¢å¾ˆã€Œä¾¿å®œã€(Deep Value)ã€‚</li>
                <li><strong>å‹•èƒ½ (Mom):</strong> åˆ†æ•¸é«˜ä»£è¡¨è¿‘æœŸè‚¡åƒ¹å¼·å‹¢ï¼Œæ­£åœ¨ä¸Šæ¼²è¶¨å‹¢ä¸­ã€‚</li>
                <li><strong>å“è³ª (Quality):</strong> ä»£è¡¨å…¬å¸è³ºéŒ¢èƒ½åŠ›èˆ‡è²¡å‹™é«”è³ªæ˜¯å¦ç©©å¥ã€‚</li>
            </ul>
        </div>
    </div>

    <div class="content-grid" id="main-display-area">
        <div class="chart-section">
            <div class="canvas-container">
                <canvas id="radarChart"></canvas>
            </div>
            <div id="tags-container"></div>
            
            <div id="trend-wrapper" class="trend-container">
                <div class="trend-header">
                    <div class="trend-title">ğŸ’“ é¢¨éšªå¿ƒé›»åœ– (Beta Trend)</div>
                    <div id="trend-badge" class="trend-badge status-neutral">--</div>
                </div>
                <div id="trend-comment" style="font-size:0.9em; color:#666; margin-bottom:10px; background:#f8f9fa; padding:10px; border-radius:8px;"></div>
                <div style="height: 120px; width:100%;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="insight-section" id="insight-panel">
            <div class="insight-title" id="insight-title-text">ğŸ“Š AI è¨ºæ–·å ±å‘Š</div>
            <ul class="insight-list" id="insight-content"></ul>
            <div style="margin-top:20px; text-align:right; font-size:0.8em; color:#999;">
                æ•¸æ“šæ—¥æœŸ: <span id="data-date">Loading...</span>
            </div>
        </div>
    </div>

    <div class="compliance-section">
        <strong>âš ï¸ å…è²¬è²æ˜ (Disclaimer):</strong><br>
        æœ¬å·¥å…·åƒ…ä¾›æ•™å­¸èˆ‡è¼”åŠ©åˆ†æä½¿ç”¨ï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ã€‚å› å­æ•¸æ“šåŸºæ–¼æ­·å²çµ±è¨ˆï¼Œå­˜åœ¨ç´„ 1 å€‹æœˆçš„å­¸è¡“æ»¯å¾Œã€‚Data Source: Kenneth R. French Data Library.
    </div>
</div>

<script>
    // --- æ³¨å…¥è®Šæ•¸ ---
    var factorCSV = `INJECT_FACTOR_CSV`;
    var returnsCSV = `INJECT_RETURNS_CSV`;

    let stockData = {};
    let stockReturnsData = null; 
    let myChart = null;
    let trendChart = null;
    
    // [UPDATED] Reordered axis labels to match requested layout
    // Order: Top -> Clockwise
    // 1. Beta (Top)
    // 2. Quality (Right)
    // 3. Momentum (Bottom Right)
    // 4. Value (Bottom Left)
    // 5. Size (Left)
    const axisLabels = ['æ³¢å‹•é¢¨éšª (Market Beta)', 'ç²åˆ©å“è³ª (Quality)', 'è‚¡åƒ¹å‹•èƒ½ (Momentum)', 'ä¾¿å®œä¼°å€¼ (Value)', 'å¸‚å€¼è¦æ¨¡ (Small Size)'];
    
    const presets = {
        'buffett': [['KO', 40], ['AXP', 20], ['BAC', 20], ['CVX', 10], ['KHC', 10]],
        'ark': [['TSLA', 30], ['COIN', 25], ['ROKU', 25], ['U', 20]],
        'paris': [['GOOGL', 20], ['RKLB', 15], ['SLV', 10], ['ALB', 10], ['RTX', 12], ['STT', 12], ['AVGO', 12], ['SOFI', 9]]
    };

    window.onload = function() {
        if (factorCSV && factorCSV !== "INJECT_FACTOR_CSV") {
            Papa.parse(factorCSV, { header: true, skipEmptyLines: true, complete: res => initData(res.data) });
        } else {
            Papa.parse("stock_factor_data.csv", { download: true, header: true, complete: res => initData(res.data) });
        }

        if (returnsCSV && returnsCSV !== "INJECT_RETURNS_CSV") {
            Papa.parse(returnsCSV, { header: true, dynamicTyping: true, skipEmptyLines: true, complete: res => { stockReturnsData = res.data; } });
        } else {
            Papa.parse("stock_returns_data.csv", { download: true, header: true, dynamicTyping: true, skipEmptyLines: true, complete: res => { stockReturnsData = res.data; } });
        }
    };

    function initData(data) {
        data.forEach(row => { if(row.Ticker) stockData[row.Ticker] = row; });
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        event.currentTarget.classList.add('active');

        if (tabId === 'about' || tabId === 'correlation') {
            document.getElementById('main-display-area').style.display = 'none';
        } else {
            document.getElementById('main-display-area').style.display = 'flex';
        }
        
        if(tabId === 'single' || tabId === 'portfolio') document.getElementById('trend-wrapper').style.display = 'none';
        
        // Auto-calculate for correlation tab
        if (tabId === 'correlation') {
            setTimeout(calculateCorrelation, 100); 
        }
    }

    // --- Charting ---
    const radarBackgroundPlugin = {
        id: 'radarBackground',
        beforeDraw: (chart) => {
            if (chart.config.type !== 'radar') return;
            const ctx = chart.ctx; const {r} = chart.scales; const xCenter = r.xCenter, yCenter = r.yCenter;
            ctx.save(); ctx.beginPath(); ctx.arc(xCenter, yCenter, r.getDistanceFromCenterForValue(5), 0, 2 * Math.PI); ctx.fillStyle = 'rgba(46, 125, 50, 0.05)'; ctx.fill();
            ctx.beginPath(); ctx.arc(xCenter, yCenter, r.getDistanceFromCenterForValue(8), 0, 2 * Math.PI); ctx.strokeStyle = 'rgba(231, 76, 60, 0.3)'; ctx.lineWidth = 1; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.restore();
        }
    };

    function renderRadar(datasets) {
        if (myChart) myChart.destroy();
        const ctx = document.getElementById('radarChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'radar',
            data: { labels: axisLabels, datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    r: { 
                        min: 0, max: 10, 
                        pointLabels: { font: { size: 12, weight: 'bold' }, color: '#333' }, 
                        grid: { color: '#e0e0e0' }, 
                        ticks: { display: false },
                        startAngle: 0 // Optional: can adjust rotation if needed
                    } 
                },
                plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { let val = context.raw; let label = context.dataset.label || ''; let comment = ""; if(val > 7.5) comment = " (æ¥µé«˜ğŸ”¥)"; else if(val < 3) comment = " (åä½ğŸ§Š)"; return `${label}: ${val}${comment}`; } } } }
            },
            plugins: [radarBackgroundPlugin]
        });
    }

    // [UPDATED] Reordered scores to match new axisLabels order
    // Order: Beta -> Quality -> Momentum -> Value -> Size
    function getScores(d) {
        return [
            parseFloat(d.Score_Beta) / 10,    // 1. Beta (Top)
            parseFloat(d.Score_Quality) / 10, // 2. Quality (Right)
            parseFloat(d.Score_Mom) / 10,     // 3. Momentum (Bottom Right)
            parseFloat(d.Score_Value) / 10,   // 4. Value (Bottom Left)
            parseFloat(d.Score_Size) / 10     // 5. Size (Left)
        ];
    }

    function updateSingleChart() {
        let ticker = document.getElementById('tickerInput').value.toUpperCase().trim();
        let data = stockData[ticker];
        if(!data) { alert('æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼ (å¯èƒ½æœªåœ¨è³‡æ–™åº«ä¸­)'); return; }
        showInsightPanel(ticker, data.Last_Date);
        renderTags(data.Baskets);
        generateInsights(data, 'single');
        renderRadar([{ label: ticker, data: getScores(data), borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.25)', pointBackgroundColor: '#007bff' }]);
        if (data.Beta_Trend) { document.getElementById('trend-wrapper').style.display = 'block'; renderTrendChart(data.Beta_Trend, ticker); } 
        else { document.getElementById('trend-wrapper').style.display = 'none'; }
        document.getElementById('filter-results-container').style.display = 'none';
    }

    function updatePeerChart() {
        let tA = document.getElementById('peerA').value.toUpperCase().trim();
        let tB = document.getElementById('peerB').value.toUpperCase().trim();
        let dataA = stockData[tA]; let dataB = stockData[tB];
        if(!dataA || !dataB) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç¢¼'); return; }
        showInsightPanel(`${tA} vs ${tB}`, dataA.Last_Date);
        document.getElementById('tags-container').innerHTML = ''; 
        document.getElementById('trend-wrapper').style.display = 'none';
        let ul = document.getElementById('insight-content');
        ul.innerHTML = `<li><strong>æ¯”è¼ƒ:</strong> é‡ç–Šå€åŸŸé¡¯ç¤ºå› å­å·®ç•°ã€‚</li><li><strong>${tA}:</strong> Beta ${dataA.Score_Beta}</li><li><strong>${tB}:</strong> Beta ${dataB.Score_Beta}</li>`;
        renderRadar([
            { label: tA, data: getScores(dataA), borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)' },
            { label: tB, data: getScores(dataB), borderColor: '#fd7e14', backgroundColor: 'rgba(253,126,20,0.1)' }
        ]);
    }

    // ... (rest of functions remain identical) ...
    function loadPreset(type) {
        let tbody = document.querySelector('#portfolioTable tbody'); tbody.innerHTML = '';
        let items = presets[type];
        if(items) {
            items.forEach(item => {
                let row = tbody.insertRow();
                row.innerHTML = `<td><input type="text" class="portfolio-input" value="${item[0]}"></td><td><input type="number" class="weight-input" value="${item[1]}"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td>`;
            });
            setTimeout(updatePortfolioChart, 100);
        }
    }
    function addPortfolioRow() {
        let table = document.querySelector('#portfolioTable tbody');
        if(table.rows.length >= 10) return;
        let newRow = table.insertRow();
        newRow.innerHTML = `<td><input type="text" class="portfolio-input" value=""></td><td><input type="number" class="weight-input" value="0"></td><td><span class="remove-row" onclick="removeRow(this)">Ã—</span></td>`;
    }
    function removeRow(span) { span.parentElement.parentElement.remove(); }

    function updatePortfolioChart() {
        let rows = document.querySelectorAll('#portfolioTable tbody tr');
        let portfolioScores = [0,0,0,0,0]; let totalWeight = 0;
        for(let row of rows) {
            let ticker = row.querySelector('.portfolio-input').value.toUpperCase().trim();
            let weight = parseFloat(row.querySelector('.weight-input').value);
            if(!ticker || !stockData[ticker]) continue;
            totalWeight += weight;
            let s = getScores(stockData[ticker]);
            for(let i=0; i<5; i++) portfolioScores[i] += s[i] * (weight/100);
        }
        if(Math.abs(totalWeight - 100) > 1) { alert(`ç›®å‰ç¸½æ¬Šé‡ç‚º ${totalWeight}%ï¼Œè«‹èª¿æ•´è‡³ 100%`); return; }
        showInsightPanel("æˆ‘çš„æŠ•è³‡çµ„åˆ", "åŠ æ¬Šè¨ˆç®—");
        document.getElementById('tags-container').innerHTML = '';
        document.getElementById('trend-wrapper').style.display = 'none';
        let pfData = { Score_Beta: portfolioScores[0], Score_Quality: portfolioScores[1], Score_Mom: portfolioScores[2], Score_Value: portfolioScores[3], Score_Size: portfolioScores[4] };
        generateInsights(pfData, 'portfolio');
        renderRadar([{ label: 'çµ„åˆ DNA', data: portfolioScores, borderColor: '#8e44ad', backgroundColor: 'rgba(142, 68, 173, 0.25)', pointBackgroundColor: '#8e44ad' }]);
    }

    function calculateCorrelation() {
        if (!stockReturnsData) return alert("éŒ¯èª¤ï¼šå›å ±æ•¸æ“šå°šæœªè¼‰å…¥ (stock_returns_data.csv)");
        let inputStr = document.getElementById('corrInput').value;
        if (!inputStr.trim()) return alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼");

        let tickers = inputStr.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
        if (tickers.length < 2) return alert("è«‹è‡³å°‘è¼¸å…¥ 2 æª”è‚¡ç¥¨é€²è¡Œæ¯”è¼ƒ");

        let dataSeries = {};
        let availableTickers = [];
        let firstRow = stockReturnsData[0];
        
        tickers.forEach(t => {
            if (firstRow.hasOwnProperty(t)) {
                availableTickers.push(t);
                dataSeries[t] = stockReturnsData.map(row => row[t]);
            }
        });
        if (availableTickers.length < 2) return alert("æœ‰æ•ˆè‚¡ç¥¨ä¸è¶³ (è«‹ç¢ºèªä»£ç¢¼å­˜åœ¨æ–¼è³‡æ–™åº«)");

        let totalCorr = 0;
        let count = 0;

        let html = '<table class="corr-table"><thead><tr><th></th>';
        availableTickers.forEach(t => { html += `<th>${t}</th>`; });
        html += '</tr></thead><tbody>';

        availableTickers.forEach((rowTicker, i) => {
            html += `<tr><td>${rowTicker}</td>`;
            availableTickers.forEach((colTicker, j) => {
                let corr = 0;
                let displayVal = "";
                let bgStyle = "";
                let textColor = "#2c3e50";

                if (rowTicker === colTicker) {
                    displayVal = "-";
                    bgStyle = "background-color: #f8f9fa;";
                    textColor = "#bdc3c7";
                } else {
                    corr = getPearsonCorrelation(dataSeries[rowTicker], dataSeries[colTicker]);
                    displayVal = corr.toFixed(2);
                    
                    if (j > i) {
                        totalCorr += corr;
                        count++;
                    }

                    if (corr > 0.7) {
                        let opacity = (corr - 0.7) * 3.3; 
                        bgStyle = `background-color: rgba(231, 76, 60, ${0.1 + opacity});`; 
                        if (corr > 0.85) textColor = "#c0392b";
                    } else if (corr < -0.2) {
                        let opacity = Math.abs(corr);
                        bgStyle = `background-color: rgba(39, 174, 96, ${opacity});`;
                        if (opacity > 0.5) textColor = "#fff";
                    }
                }
                html += `<td style="${bgStyle} color:${textColor}">${displayVal}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('correlation-container').innerHTML = html;

        let summaryDiv = document.getElementById('corr-summary');
        if (count > 0) {
            let avgCorr = totalCorr / count;
            let summaryClass = "";
            let summaryTitle = "";
            let summaryDesc = "";

            if (avgCorr > 0.6) {
                summaryClass = "corr-high";
                summaryTitle = "ğŸš¨ é«˜åº¦é›†ä¸­é¢¨éšª (High Concentration)";
                summaryDesc = "å¹³å‡ç›¸é—œä¿‚æ•¸: <strong>" + avgCorr.toFixed(2) + "</strong>ã€‚æ‚¨çš„æŒå€‰é«˜åº¦é€£å‹•ï¼Œå¸‚å ´ä¸‹è·Œæ™‚å¯èƒ½ç¼ºä¹ä¿è­·ã€‚";
            } else if (avgCorr < 0.3) {
                summaryClass = "corr-low";
                summaryTitle = "âœ… åˆ†æ•£åº¦è‰¯å¥½ (Well Diversified)";
                summaryDesc = "å¹³å‡ç›¸é—œä¿‚æ•¸: <strong>" + avgCorr.toFixed(2) + "</strong>ã€‚æ‚¨çš„æŒå€‰å½¼æ­¤é€£å‹•æ€§ä½ï¼Œå…·æœ‰è‰¯å¥½çš„é¿éšªæ•ˆæœã€‚";
            } else {
                summaryClass = "corr-mid";
                summaryTitle = "âš ï¸ ä¸­åº¦ç›¸é—œ (Moderate)";
                summaryDesc = "å¹³å‡ç›¸é—œä¿‚æ•¸: <strong>" + avgCorr.toFixed(2) + "</strong>ã€‚æŒå€‰æœ‰ä¸€å®šé€£å‹•æ€§ï¼Œè«‹ç•™æ„å¸‚å ´ç³»çµ±æ€§é¢¨éšªã€‚";
            }

            summaryDiv.className = "corr-summary corr-summary-box " + summaryClass;
            summaryDiv.innerHTML = `<div class="corr-summary-title">${summaryTitle}</div><div class="corr-summary-text">${summaryDesc}</div>`;
            summaryDiv.style.display = "block";
        } else {
            summaryDiv.style.display = "none";
        }
    }

    function getPearsonCorrelation(x, y) {
        let shortest = Math.min(x.length, y.length);
        let xy = [], x2 = [], y2 = [], n = 0;
        for(let i=0; i<shortest; i++) {
            let xi = x[i], yi = y[i];
            if(typeof xi === 'number' && typeof yi === 'number' && !isNaN(xi) && !isNaN(yi)) {
                xy.push(xi * yi); x2.push(xi * xi); y2.push(yi * yi); n++;
            }
        }
        if(n === 0) return 0;
        let sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0, sum_y2 = 0;
        let valid_x = [], valid_y = [];
        for(let i=0; i<shortest; i++) {
             if(typeof x[i] === 'number' && typeof y[i] === 'number' && !isNaN(x[i]) && !isNaN(y[i])) {
                 valid_x.push(x[i]); valid_y.push(y[i]);
             }
        }
        for(let i=0; i<n; i++) {
            sum_x += valid_x[i]; sum_y += valid_y[i];
            sum_xy += valid_x[i] * valid_y[i];
            sum_x2 += valid_x[i] * valid_x[i]; sum_y2 += valid_y[i] * valid_y[i];
        }
        let step1 = (n * sum_xy) - (sum_x * sum_y);
        let step2 = (n * sum_x2) - (sum_x * sum_x);
        let step3 = (n * sum_y2) - (sum_y * sum_y);
        let denominator = Math.sqrt(step2 * step3);
        return denominator === 0 ? 0 : step1 / denominator;
    }

    function renderTrendChart(trendStr, ticker) {
        if (trendChart) trendChart.destroy();
        const ctx = document.getElementById('trendChart').getContext('2d');
        let dataPoints = trendStr.split(',').map(Number);
        let currentBeta = dataPoints[dataPoints.length - 1];
        let badge = document.getElementById('trend-badge');
        let msg = "";
        if (currentBeta > 1.3) { badge.innerText = "âš ï¸ é«˜é¢¨éšª"; badge.className = "trend-badge status-danger"; msg = `<strong>${ticker} æ­£åœ¨ç™¼ç‡’ï¼š</strong>ç›®å‰çš„æ³¢å‹•åº¦æ˜¯å¸‚å ´çš„ ${currentBeta} å€ã€‚`; } 
        else if (currentBeta < 0.8) { badge.innerText = "ğŸ›¡ï¸ é˜²ç¦¦å‹"; badge.className = "trend-badge status-safe"; msg = `<strong>${ticker} å¾ˆå†·éœï¼š</strong>ç›®å‰çš„æ³¢å‹•åº¦ä½æ–¼å¤§ç›¤ã€‚`; } 
        else { badge.innerText = "âš–ï¸ è·Ÿéš¨å¤§ç›¤"; badge.className = "trend-badge status-neutral"; msg = `<strong>${ticker} éš¨æ³¢é€æµï¼š</strong>å®ƒçš„é¢¨éšªå±¬æ€§èˆ‡å¤§ç›¤æŒ‡æ•¸ (S&P 500) ç›¸ç•¶æ¥è¿‘ã€‚`; }
        document.getElementById('trend-comment').innerHTML = msg;
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: dataPoints.length}, (_, i) => i),
                datasets: [{
                    label: 'Beta', data: dataPoints,
                    borderColor: currentBeta > 1.2 ? '#e74c3c' : '#2ecc71', borderWidth: 2, pointRadius: 0, tension: 0.4,
                    fill: { target: {value: 1.0}, above: 'rgba(231, 76, 60, 0.1)', below: 'rgba(46, 125, 50, 0.1)' }
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { intersect: false } }, scales: { x: { display: false }, y: { display: true, suggestedMin: 0.5, suggestedMax: 1.5 } } }
        });
    }

    function showInsightPanel(t, d) { document.getElementById('insight-panel').style.display = 'block'; document.getElementById('insight-title-text').innerText = "ğŸ“Š åˆ†æå ±å‘Š: " + t; document.getElementById('data-date').innerText = d; }
    
    function generateInsights(data, mode) {
        const ul = document.getElementById('insight-content'); ul.innerHTML = '';
        const addLi = (title, text) => { let li = document.createElement('li'); li.innerHTML = `<span class="insight-highlight">${title}</span> ${text}`; ul.appendChild(li); };
        
        let beta = parseFloat(data.Score_Beta) / 10;
        let val = parseFloat(data.Score_Value) / 10;
        let size = parseFloat(data.Score_Size) / 10;
        let qual = parseFloat(data.Score_Quality) / 10;
        let mom = parseFloat(data.Score_Mom) / 10;

        if (mode === 'portfolio') {
            if (beta > 7) addLi("å¿ƒè‡Ÿå¤ å¤§é¡†å—ï¼Ÿ", "æ‚¨çš„çµ„åˆæ³¢å‹•åº¦å¾ˆé«˜ã€‚åœ¨å¤§ç‰›å¸‚æœƒè³ºå¾ˆçˆ½ï¼Œä½†ç©ºé ­ä¾†è¥²æ™‚æœƒå—é‡å‚·ã€‚å»ºè­°åŠ å…¥ä¸€äº›é˜²ç¦¦å‹é…ç½® (å¦‚ KO, JNJ)ã€‚");
            else if (beta < 4) addLi("é€€ä¼‘é¤Šè€å‹ï¼š", "æ‚¨çš„çµ„åˆéå¸¸ç©©å¥ä¿å®ˆï¼Œæ™šä¸Šç¡å¾—è‘—è¦ºï¼Œä½†åœ¨å¸‚å ´å¤§æ¼²æ™‚ç¸¾æ•ˆå¯èƒ½æœƒè½å¾Œã€‚");
            else addLi("æ”»å®ˆå¹³è¡¡ï¼š", "ç›®å‰çš„é…ç½®ç›¸ç•¶æ¨™æº–ï¼Œæ—¢æœ‰æ”»æ“ŠåŠ›ä¹Ÿæœ‰é˜²è­·ç½©ã€‚");
            if (val < 3 && qual < 4) addLi("æ³¨æ„æ³¡æ²«é¢¨éšªï¼š", "æ‚¨æŒæœ‰å¾ˆå¤šã€Œé«˜æœ¬ç›Šæ¯” + ä½ç²åˆ©ã€çš„è‚¡ç¥¨ã€‚é€™æ˜¯å…¸å‹çš„æŠ•æ©Ÿçµ„åˆï¼Œè«‹å¯†åˆ‡é—œæ³¨åˆ©ç‡è®ŠåŒ–ã€‚");
        } else {
            if (beta > 8) addLi("ç˜‹ç‹—æµªè­¦ç¤ºï¼š", "æ³¢å‹•æ¥µå¤§ï¼é€™é¡è‚¡ç¥¨é©åˆçŸ­ç·šæ“ä½œï¼Œé•·æŠ±å®¹æ˜“åƒåé›²éœ„é£›è»Šã€‚");
            else if (beta < 3) addLi("è³‡é‡‘é¿é¢¨æ¸¯ï¼š", "å¸‚å ´å´©ç›¤æ™‚ï¼Œé€™é¡è‚¡ç¥¨é€šå¸¸è·Œå¾—æ¯”è¼ƒå°‘ã€‚");
            if (val > 8) addLi("æ·±åº¦ç‰¹åƒ¹å“ï¼š", "è‚¡åƒ¹ç›¸å°æ–¼åŸºæœ¬é¢éå¸¸ä¾¿å®œ (Deep Value)ã€‚å¯èƒ½æ˜¯è¢«éŒ¯æ®ºçš„é»ƒé‡‘ï¼Œä¹Ÿå¯èƒ½æ˜¯åƒ¹å€¼é™·é˜±ã€‚");
            if (val < 2) addLi("æ˜‚è²´çš„å¤¢æƒ³ï¼š", "å¸‚å ´çµ¦äºˆæ¥µé«˜ä¼°å€¼ (High Growth)ã€‚è‚¡åƒ¹æ˜¯é æœªä¾†çš„æƒ³åƒç©ºé–“æ”¯æ’ï¼Œè²¡å ±ä¸èƒ½å‡ºéŒ¯ã€‚");
            if (qual > 7) addLi("è³‡å„ªç”Ÿé«”è³ªï¼š", "å…¬å¸å¾ˆæœƒè³ºéŒ¢ (High Profitability)ï¼Œè²¡å‹™ç©©å¥ï¼Œé©åˆé•·æœŸå­˜è‚¡ã€‚");
            if (qual < 3) addLi("é«”è³ªè™›å¼±ï¼š", "å…¬å¸ç²åˆ©èƒ½åŠ›ä¸ä½³ã€‚å¦‚æœè‚¡åƒ¹åœ¨æ¼²ï¼Œé€šå¸¸æ˜¯é é¡Œæç‚’ä½œã€‚");
            if (mom > 8) addLi("äººæ°£ç‹ï¼š", "è¿‘æœŸè‚¡åƒ¹å¼·å‹¢å™´å‡ºï¼Œé †å‹¢äº¤æ˜“è€…æœ€æ„›ã€‚ä½†è¦å°å¿ƒä¹–é›¢éå¤§å›èª¿ã€‚");
            if (mom < 2) addLi("å†·å®®è‚¡ï¼š", "è‚¡åƒ¹è¶¨å‹¢å‘ä¸‹ï¼Œå¸‚å ´ç›®å‰ä¸æ„›å®ƒã€‚é™¤éæ‚¨æ˜¯é€†å‹¢äº¤æ˜“é«˜æ‰‹ï¼Œå¦å‰‡åˆ¥æ€¥è‘—æ¥åˆ€ã€‚");
        }
    }
    
    function filterStocks(c) {
        let div = document.getElementById('filter-results-buttons'); div.innerHTML = ''; let count = 0;
        for(let t in stockData) {
            if(stockData[t].Baskets && stockData[t].Baskets.includes(c)) {
                let btn = document.createElement('button'); btn.className = 'stock-btn'; btn.innerText = t;
                btn.onclick = function() { document.getElementById('tickerInput').value = t; updateSingleChart(); };
                div.appendChild(btn); count++;
            }
        }
        document.getElementById('filter-results-container').style.display = count ? 'block' : 'none';
        if(count==0) alert('ç›®å‰è³‡æ–™åº«ä¸­ç„¡ç¬¦åˆæ­¤æ¢ä»¶çš„è‚¡ç¥¨');
    }
    function renderTags(basketsStr) {
        const container = document.getElementById('tags-container'); container.innerHTML = '';
        if (basketsStr) basketsStr.split(';').forEach(tag => {
            tag = tag.trim();
            let span = document.createElement('span'); span.className = 'tag blue';
            if(tag.includes('Aggressive') || tag.includes('Speculative') || tag.includes('Knife')) span.className = 'tag red';
            if(tag.includes('Quality') || tag.includes('Defensive')) span.className = 'tag green';
            if(tag.includes('High Beta')) tag = "âš¡ é«˜æ³¢å‹•";
            if(tag.includes('Defensive')) tag = "ğŸ›¡ï¸ é˜²ç¦¦å‹";
            if(tag.includes('Small Cap')) tag = "ğŸ£ å°å‹è‚¡";
            if(tag.includes('Large Cap')) tag = "ğŸ˜ å¤§å‹è‚¡";
            if(tag.includes('Deep Value')) tag = "ğŸ’° åƒ¹å€¼è‚¡";
            if(tag.includes('High Growth')) tag = "ğŸš€ æˆé•·è‚¡";
            if(tag.includes('High Quality')) tag = "ğŸ’ é«˜å“è³ª";
            if(tag.includes('Junk')) tag = "âš ï¸ æŠ•æ©Ÿç´š";
            span.innerText = tag; container.appendChild(span);
        });
    }
</script>

</body>
</html>